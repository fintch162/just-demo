<% @manual_payments.each_with_index do |manual_payment, index| %>
  <% job = Job.find_by_id(manual_payment.job_id) %>
  <%= content_tag_for :tr, manual_payment do %>
    <% if manual_payment.committed? && !manual_payment.payment_id.blank? %>
      <% isCommited = "none" %>
    <% else %>
      <% isCommited = "initial" %>
    <% end %>
    <td>
      <%= index + 1 %>
    </td>

    <td>
      <%= manual_payment.payment_date.strftime('%d/%m/%y') %>
    </td>
    
    <td>
      <%= link_to "REF #{manual_payment.job_id}", manage_job_path(manual_payment.job_id), :target => "_blank" unless job.nil?%>
    </td>

    <td>
      <%= manual_payment.job_status %>
    </td>

    <td>
      <a href="javascript:;" id="editReferral_<%= manual_payment.id %>" class="editReferral" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
      <%= best_in_place manual_payment, :referral, :as => :input, :path => [ :manage, manual_payment ], :activator => "#editReferral_#{manual_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputReferral" %>
    </td>

    <td>
      <a href="javascript:;" id="editBalance_<%= manual_payment.id %>" class="editBalance" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
      <%= best_in_place manual_payment, :balance, :as => :input, :path => [ :manage, manual_payment ], :activator => "#editBalance_#{manual_payment.id}", inner_class: "form-control bestinplaceInputBalance paymentAmount" %>
    </td>

    <td>
      <%= best_in_place manual_payment, :amount, :as => :input, :path => [ :manage, manual_payment ], :activator => "#editAmount_#{manual_payment.id}", inner_class: "form-control paymentAmount" %>
    </td>


    <td>
      <a href="javascript:;" id="editPaymentMethod_<%= manual_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
      <%= best_in_place manual_payment, :payment_method, :type => :select, :collection => [['', ''], ['Bank Transfer', 'Bank Transfer'], ['Cash', 'Cash'],['Check','Check'],['Paypal','Paypal'],['Credit Card','Credit Card']], :include_blank => true, :path => [:manage, manual_payment], :activator => "#editPaymentMethod_#{manual_payment.id}", inner_class: "form-control" %>
    </td>

    <td>
      <a href="javascript:;" id="editGogglesStatus_<%= manual_payment.id %>"><i class="fa fa-pencil"></i></a>
      <%= best_in_place manual_payment, :goggles_status, :type => :select, :collection => [ ['', ''], ['By hand','By hand'] ,['Coach', 'Coach'],['Dispatched','Dispatched'],['No goggles','No goggles'] ], :path => [:manage, manual_payment], :activator => "#editGogglesStatus_#{manual_payment.id}", inner_class: "form-control" %>
    </td>

    <td>
      <a href="javascript:;" id="editDescription_<%= manual_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
      <%= best_in_place manual_payment, :description, :type => :input, :path => [:manage, manual_payment], :activator => "#editDescription_#{manual_payment.id}", inner_class: "form-control input-xsmall" %>
    </td>

    <td>
      <% if !job.nil? %>
      <% if job.invoices.blank? %>
        <span>-</span>
      <% elsif job.invoices.count == 1 %>
        <%= link_to(manage_freshbook_invoice_path(:online_payments_invoice_id => manual_payment.invoice_number), class: "linkToInvoice", :target => "_blank") do %>
          <%= manual_payment.invoice_number %>
        <% end %>
      <% elsif job.invoices.count > 1 %>
        <a href="javascript:;" id="editInvoice_<%= manual_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
        <%= link_to(manage_freshbook_invoice_path(:online_payments_invoice_id => manual_payment.invoice_number), class: "linkToInvoice", :target => "_blank") do %>
          <%= best_in_place manual_payment, :invoice_number, :type => :select, :collection => job.invoices.map { |p| [p.invoice_number.to_s, p.invoice_number.to_s] }, :path => [:manage, manual_payment],:activator => "#editInvoice_#{manual_payment.id}", inner_class: "form-control editInvoice" %>
        <% end %>
      <% end %>
      <% end %>
    </td>
    <td>
      <% if manual_payment.committed? && !manual_payment.payment_id.blank? %>
        <%= link_to "Uncommit", remove_payment_manage_manual_payment_path(manual_payment), :remote => true, :class => "menual_payment", :id => "manual_payment_add_"+manual_payment.id.to_s %>
        <span class="lineDraw_<%= manual_payment.id %>" style="display: none;">|</span>
        <%= link_to "Edit", edit_manage_manual_payment_path(manual_payment), class: "editPayment_#{manual_payment.id}", style: "display: none;" %>
      <% elsif manual_payment.committed? && manual_payment.payment_id.blank? %>
        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_payment), :remote => true, :class => "menual_payment", :id => "manual_payment_add_"+manual_payment.id.to_s, style: "display: none;" %>
        <span class="lineDraw" style="display: none;">|</span>
        <%= link_to "Edit", edit_manage_manual_payment_path(manual_payment), class: "editPayment_#{manual_payment.id}" %>
        
      <% else %>
        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_payment), :remote => true, :class => "menual_payment", :id => "manual_payment_add_"+manual_payment.id.to_s %>
        <span class="lineDraw_<%= manual_payment.id %>">|</span>
        <%= link_to "Edit", edit_manage_manual_payment_path(manual_payment), class: "editPayment_#{manual_payment.id}" %>
      <% end %>
    

      <script type="text/javascript">
        $(document).ready(function(){
          $('.menual_payment').click(function(){
            $(this).text("Commiting..");
          });

          $(".editReferral").click(function(event) {
            $(document).on('keydown', '.bestinplaceInputReferral', function (e) {
              checkNumberOnly(e);
            });
          });
          $(".editBalance").click(function(event) {
            $(document).on('keydown', '.bestinplaceInputBalance', function (e) {
              checkNumberOnly(e);
            });
          });

          function checkNumberOnly(e) {
            if(e.currentTarget.className.indexOf("bestinplaceInputBalance") != -1) {
              $(".bestinplaceInputBalance").css("border", "2px solid #0F7311");
              $(".bestinplaceInputBalance").attr("title", "Please enter numbers");
            }
            if(e.currentTarget.className.indexOf("bestinplaceInputReferral") != -1) {
              $(".bestinplaceInputReferral").css("border", "2px solid #0F7311");
              $(".bestinplaceInputReferral").attr("title", "Please enter numbers");
            }

            if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 || (e.keyCode == 65 && e.ctrlKey === true) || (e.keyCode >= 35 && e.keyCode <= 40)) {
                return;
            }
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
              if(e.currentTarget.className.indexOf("bestinplaceInputBalance") != -1) {
                $(".bestinplaceInputBalance").css("border", "2px solid #ff0000");
                $(".bestinplaceInputBalance").attr("title", "Please enter numbers");
              }
              if(e.currentTarget.className.indexOf("bestinplaceInputReferral") != -1) {
                $(".bestinplaceInputReferral").css("border", "2px solid #ff0000");
                $(".bestinplaceInputReferral").attr("title", "Please enter numbers");
              }
              e.preventDefault();
            }
          }
        });
      </script>
    </td>
  <% end %>
<% end %>
