
<div class="row">
  <div class="col-md-12">
    <div class="portlet box blue">
      <div class="portlet-title">
        <div class="caption">
          <i class="fa fa-comments"></i>Payments List
        </div>
      </div>
      <div class="portlet-body" style="border-bottom: 1px solid #67809F;">
        <div class="row">
          <div class="col-sm-6 pull-left"></div>
          <div class="col-sm-2">
            <h4><b> Referral : </b><span id="referral"><%= @manual_payments.sum('referral') %></span></h4>
          </div>
          <div class="col-sm-2">
            <h4><b> Balance : </b><span id="balance"><%= @manual_payments.sum('balance') %></span></h4>
          </div>
          <div class="col-sm-2">
            <h4><b> Total : </b><span id="amount"><%= @manual_payments.sum('amount') %></span></h4>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>No</th>
                <th>Date</th>
                <th>Job ID</th>
                <th>Job Status</th>
                <th>Referral</th>
                <th>Balance</th>
                <th>Total</th>
                <th>Payment Method</th>
                <th>Goggles Status</th>
                <th>Notes</th>
                <th>Invoice</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="manualPayments" data-update-url="<%= sort_manage_manual_payments_path %>">
              <% cnt = 1 %>              
                <%= render "uncommitted_manual_payment_data" %>
                <% cnt += 1 %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $(document).ready(function() {
    var cnt = 0;

    $('.best_in_place').best_in_place();

    $('#manualPayments').sortable({
      axis: "y",
      containerSelector: 'table',
      itemPath: '> tbody',
      itemSelector: 'tr',
      placeholder: 'placeholder',
      update: function() {
        $.post($(this).data("update-url"), $(this).sortable("serialize"));
      }
    });

    $(document).on('focusout', '.commitedStatus', function(){
      var selectedStatus = $(this).find('option:selected').text();
      if(selectedStatus == "No") {

        $(this).parents('tr').find('.lineDraw').show();
        $(this).parents('tr').find('.menual_payment').show();
      }
      else {
        $(this).parents('tr').find('.lineDraw').hide();
        $(this).parents('tr').find('.menual_payment').hide();
      }
    });
    $(document).on('focusout', '.editInvoice', function(){
      var oldUrl = $(this).parents('.linkToInvoice').attr('href');
      var newUrl = "/manage/invoice?online_payments_invoice_id="+$(this).find('option:selected').text();
      $(this).parents('.linkToInvoice').attr('href', newUrl);
    });

    var selectorToUpdate;
    var referral;
    var balance;
    var amount;
    var totalAmt;

    $(document).on('focusout', '.bestinplaceInputReferral', function(){
      selectorToUpdate = $(this).parents('span').data("bip-activator");
      referral = $(this).val();
      if(referral == "-")
        referral = 0
      balance = $(this).parents('tr').find('[data-bip-activator="#editBalance_'+selectorToUpdate.split("_")[1]+'"]').text();
      if(balance == "-")
        balance = 0
      amount = $(this).parents('tr').find('[data-bip-activator="#editAmount_'+selectorToUpdate.split("_")[1]+'"]').text(Number(referral) + Number(balance));

      totalAmt = Number(referral) + Number(balance)
      if(isNaN(totalAmt))
        amount = $(this).parents('tr').find('[data-bip-activator="#editAmount_'+selectorToUpdate.split("_")[1]+'"]').text("-");
      else
        amount = $(this).parents('tr').find('[data-bip-activator="#editAmount_'+selectorToUpdate.split("_")[1]+'"]').text(totalAmt);
    });

    $(document).on('focusout', '.bestinplaceInputBalance', function(){
      selectorToUpdate = $(this).parents('span').data("bip-activator");
      referral = $(this).val();
      if(referral == "-")
        referral = 0
      balance = $(this).parents('tr').find('[data-bip-activator="#editReferral_'+selectorToUpdate.split("_")[1]+'"]').text();
      if(balance == "-")
        balance = 0
      totalAmt = Number(referral) + Number(balance)
      if(isNaN(totalAmt))
        amount = $(this).parents('tr').find('[data-bip-activator="#editAmount_'+selectorToUpdate.split("_")[1]+'"]').text("-");
      else
        amount = $(this).parents('tr').find('[data-bip-activator="#editAmount_'+selectorToUpdate.split("_")[1]+'"]').text(totalAmt);
    });

  });
</script>
<style type="text/css">
  .paymentAmount { 
    width: 35px;
  }
  .sorted_table tr.placeholder {
    display: block;
    position: relative;
    margin: 0;
    padding: 0;
    border: none;
  }
  .sorted_table tr.placeholder:before {
    content: "";
    position: absolute;
    width: 0;
    height: 0;
    border: 5px solid transparent;
    border-left-color: red;
    margin-top: -5px;
    left: -5px;
    border-right: none;
  }
</style>
