<% title "SMS" %> 

<% init_class = Test.new %>
<h3 class="page-title">
  SMS
  <small>
    from telerivet
  </small>
</h3>
<div class="row inbox">
  <div class="col-md-2">
    <ul class="inbox-nav margin-bottom-10">
      <li class="compose-btn">
        <a class="btn default" data-toggle="modal" href="#responsive">
          <i class="fa fa-edit"></i>
          New SMS
        </a>
      </li>
      <li class="inbox active">
        <%= link_to "Conversations", manage_messages_path , :class => "btn" %>
        <b></b>
      </li>
      <li class="sent">
        <%= link_to "Incoming", manage_db_incoming_message_path , :class => "btn"%>
        <b></b>
      </li>
      <li class="draft">
        <%= link_to "Outgoing", manage_db_outgoing_message_path, :class => "btn"%>
        <b></b>
      </li>
      <li class="trash">
        <%= link_to "Failed", manage_incoming_messages_path, :class => "btn", :remote => true %>
        <b></b>
      </li>
    </ul>
  </div>
  <div class="col-md-10 parent_incomming">
    <div class="inbox-header">
      <h1 class="pull-left">Conversations</h1>
      <% if @conversations != "Disconnected" %>
        <span class="pull-right">
          <%= form_tag url_for(:controller => 'coordinator_messages', :action => 'search'), :method => 'get' do %>
            <%= text_field_tag :search, params[:search], :class => "form-control" %>
          <% end %>
        </span>
      <% end %>
    </div>
    <% if @conversations == "Disconnected" %>
      <tr class="unread" data-messageid="1">
        <td colspan="3" class="alert alert-danger" style="background: #fff;">
          <div class="Metronic-alerts alert alert-danger fade in">You will need to setup your telerivet API in order to send or receive SMS</div>
        </td>
      </tr> 
    <% else %>
      <div class="inbox-loading" style="display: none;">
        Loading...
      </div>
      <div class="inbox-content">
        <table class="table table-striped table-advance table-hover">
          <thead>
            <tr>
              <th colspan="7">
                <div class="btn-group">
                  <a class="btn btn-sm blue" data-toggle="dropdown" href="#">
                    More
                    <i class="fa fa-angle-down"></i>
                  </a>
                  <ul class="dropdown-menu">
                    <li>
                      <a href="#">
                        <i class="fa fa-pencil"></i>
                        Mark as Read
                      </a>
                    </li>
                    <li>
                      <a href="#">
                        <i class="fa fa-ban"></i>
                        Spam
                      </a>
                    </li>
                    <li class="divider"></li>
                    <li>
                      <a href="#">
                        <i class="fa fa-trash-o"></i>
                        Delete
                      </a>
                    </li>
                  </ul>

                </div>
                <span class="pull-right">
                <% if @conversations != "Disconnected" %>
                  <%= will_paginate @conversations, :previous_label => '<i class="fa fa-angle-left"></i>', :next_label => '<i class="fa fa-angle-right"></i>', :page_links => false%>
                <% end %>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <% if @conversations == "Disconnected" %>
              <tr class="unread" data-messageid="1">
                <td colspan="3" class="alert alert-danger" style="background: #fff;">
                  <div class="Metronic-alerts alert alert-danger fade in">You will need to setup your telerivet API in order to send or receive SMS</div>
                </td>
              </tr> 
            <% else %>  
              <% if @conversations.count == 0 %>
                <tr class="unread" data-messageid="1">
                  <td colspan="3" style="background: #fff;">
                    <h3>No messages found!</h3>
                  </td>
                </tr>        
              <% else %>
              
              <%#=  @final_uniq_number.sort_by{|e| e[:time_created]} %>
                <% @conversations.each do |message| %>
                  <% if message.direction == "Incoming" || message.direction == "incoming" %>
                    <tr class="unread" data-messageid="1">
                      <td class="view-message" style="width: 20px;">
                        <% if message.from_number.include?('+') %>
                          <% if message.from_number.include?("^") %>
                            <%= message.from_number[4..-1] %>
                          <% else %>
                            <%= message.from_number[3..-1] %>
                          <% end %>
                        <% else %>
                          <% if message.from_number.include?("^") %>
                            <%= message.from_number.gsub('^', '') %>
                          <% else %>
                            <%= message.from_number %>
                          <% end %>
                        <% end %>
                      </td>
                      <td class="view-message" style="width: 20px;">
                        <%= message.direction.capitalize unless message.direction.nil? %>
                      </td>
                      <td class="view-message">
                        <% if !message.message_description.nil? %>
                          <%= link_to simple_format(message.message_description).html_safe, manage_conversation_message_path(message.from_number)%>
                        <% end %>
                      </td>
                      <td class="hidden-xs" style="width: 20px;"><%= message.time_created.strftime('%d/%m/%Y')%></td>
                      <td class="view-message text-right">
                        <%= message.time_created.strftime('%I:%M %p') %>
                      </td>
                    </tr>
                  <% else %>
                    <tr class="unread" data-messageid="1">
                      <td class="view-message" style="width: 20px;">
                        <% if message.to_number.include?('+') %>
                          <% if message.to_number.include?("^") %>
                            <%= message.to_number[4..-1] %>
                          <% else %>
                            <%= message.to_number[3..-1] %>
                          <% end %>
                        <% else %>
                          <% if message.to_number.include?("^") %>
                            <%= message.to_number.gsub('^', '') %>
                          <% else %>
                            <%= message.to_number %>
                          <% end %>
                        <% end %>
                      </td>
                      <td class="view-message" style="width: 20px;">
                        <%= message.direction.capitalize unless message.direction.nil? %>
                      </td>

                      <td class="view-message">
                        <% if !message.message_description.nil? %>
                          <%= link_to simple_format(message.message_description).html_safe, manage_conversation_message_path(message.to_number)%>
                        <% end %>
                      </td>
                      <td class="hidden-xs" style="width: 20px;"><%= message.time_created.strftime('%d/%m/%Y')%></td>
                      <td class="view-message text-right">
                        <%= message.time_created.strftime('%I:%M %p') %>
                      </td>
                    </tr>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>