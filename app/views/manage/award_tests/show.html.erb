<% title "Award Test Students" %>
<div class="row">
  <div class="col-md-12">
    <div class="portlet box green">
      <div class="portlet-title">
        <div class="caption">
          <i class="fa fa-user"></i>
           <% if !@award_test.test_date.blank? && !@award_test.test_time.blank? && !@award_test.award_id.blank? %>
             <%= @award_test.test_date.strftime("%A") %> <%= @award_test.test_time.strftime("%I:%M %p") %> - <%= @award_test.award.name %>
           <% end %>  
        </div>
        <div class="actions">
          <a href="#" class="btn btn-default btn-sm " onclick="window.print();" style="border: 1px solid #fff; color: #fff;"><i class="fa fa-print"></i> Print </a>
          <a href="/manage/award_test/edit/<%= @award_test.id %>" class="btn btn-default btn-sm" style="border: 1px solid #fff; color: #fff;"><i class="fa fa-pencil"></i> Edit</a>
          <a class="btn btn-default btn-sm" data-toggle="modal" href="#responsive" style="border: 1px solid #fff; color: #fff;">
            <i class="fa fa-plus"></i> student
          </a>
        </div>
      </div>
      <div class="portlet-body">
        <table class="table table-striped table-bordered table-hover" id="sample_2" >
          <thead>
            <tr>
              <th class="mycheckbox">
                <input type="checkbox" name="checkedAll" id="checkedAll" value="" class="checkedAll"></input>
                <input type="hidden" name="search_key" id="search_key" value= <%= params[:student_name] %> />
              </th>
              <th>Name</th>
              <th>Ic number</th>
              <th>Gender</th>
              <th>D.O.B</th>
              <th>Contact</th>
              <th>Payment</th>
              <th>Instructor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="award_test_table"  data-update-url="<%= sort_student_manage_award_test_path(@award_test) %>">
            <% @instructor_student_award.order("position").each do |ins| %>
              <% student = InstructorStudent.find_by_id(ins.instructor_student_id) %>  
              <% if student %>
                <tr class="text-left" id="award-test-student-<%= ins.id %>">
                  <td class="mycheckbox">
                    <input type="checkbox" name="checkAll" id="checkAll" value="<%= student.id %>" class="check_student"></input>
                  </td>
                  <td>
                    <%= student.student_name %>
                  </td> 
                  <td>
                   <%= student.ic_number %>
                  </td>
                  <td>
                   <%= student.gender %>
                  </td>
                  <td class="td_date">
                   <%= student.date_of_birth ? student.date_of_birth.strftime("%d %b %Y") :nil %>
                  </td>
                  <td>
                    <% primary_contact = student.student_contacts.where(primary_contact: true) %>
                    <% primary_contact.each do |p| %>
                      <%= p.contact %>
                    <% end %>
                  </td>
                  <td>
                    <%= AwardTestPaymentNotification.check_paid_or_not(ins.award_test.id,ins.instructor_student_id) ? 'Paid' : 'Unpaid' %>
                  </td>
                  <td>
                    <% if !student.admin_user_id.nil?%>
                      <%= Instructor.find_by_id(student.admin_user_id).name %>
                    <% end %>  
                  </td>
                  <td>
                    <div class="bnt_status" style="display: none;"><%= ins.status %></div>
                    <div class="btn-group">
                      <button type="button" class="btn default"><%= ins.status %></button>
                      <button type="button" class="btn default dropdown-toggle" style="margin-left: -6px;" data-toggle="dropdown"><i class="fa fa-angle-down"></i></button>
                      <ul class="dropdown-menu" role="menu">
                        <% if ins.status != "Confirmed" %>
                          <li>
                            <a href="<%= manage_confirm_student_path(ins, "Confirmed") %>">
                            Confirm
                            </a>
                          </li>
                        <% end %> 
                        <% if ins.status != "Pending" %>
                          <li>
                            <a href="<%= manage_confirm_student_path(ins, "Pending") %>">
                            Pending
                            </a>
                          </li>
                        <% end %> 
                        <li>
                          <a data-toggle="modal" id="basicModalOpen" href="#student_<%= ins.id %>">Remove</a>
                        </li>
                        <% if ins.status != "Pass" %>
                          <li>
                            <!-- <a href="#student_status_<%#= ins.id %>", id="baiscModalOpen" data-toggle="modal">Pass</a>
                             --><a href="<%= manage_confirm_student_path(ins, "Pass") %>">
                            Pass
                            </a>
                          </li>
                        <% end %>
                        <% if ins.status != "Fail" %>
                          <li>
                            <a href="<%= manage_confirm_student_path(ins, "Fail") %>">
                            Fail
                            </a>
                          </li>
                        <% end %>
                        <li>
                          <a href="<%=  manage_award_test_list_path(ins,test_id: params[:id]) %>" data-remote="true">
                          Transfer
                          </a>
                        </li>
                      </ul>
                    </div>
                    <!-- <%#= ins.status %> -->
                  </td>
                </tr> 
                <%= render :partial => "change_status", locals: {:student => ins, :student_name => student.student_name, :award_test => @award_test} %>
                <%= render :partial => "delete_student", locals: {:student => ins, :student_name => student.student_name} %>
              <% end %>  
            <% end %>  
          </tbody>
        </table>
      </div>

      <div id="responsive" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
              <h4 class="modal-title">Search by NRIC number</h4>
            </div>
            <div class="modal-body">
              <div class="scroller" data-always-visible="1" data-rail-visible1="1" sty;e="height: auto;">
                <div class="row">
                  <div class="col-md-12">
                  <%= form_tag manage_search_by_nric_path, :method => 'get', :remote => true do %>
                    <div class="col-md-10">
                      <%= hidden_field_tag :award_test, @award_test.id %>
                      <%= text_field_tag :search, nil,:class=>"form-control"%>
                    </div>
                    <div class="col-md-2">
                      <%= submit_tag "Search", :name => nil, :id => "nric_search_button", :class => "btn btn-default pull-right" %>
                    </div>
                  <% end %>
                  </div>
                </div>
                <div class="clear">&nbsp;</div>
                <div class="row">     
                  <div class="col-md-12 search_student_data"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="student_status" tabindex="-1" role="basic" aria-hidden="true">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title" id="del_modal_title">Update Achievements</h4>
              </div>
              <div class="modal-body row">
                <div class="col-xs-12">The achievement for selected student will be updates.</div>
                <div class="col-xs-4 text-right text-muted">Award</div>
                <div class="col-xs-8"><%= @award_test.award.name %></div>
                <div class="col-xs-4 text-right text-muted">Date</div>
                <div class="col-xs-8"><%= @award_test.test_date.strftime("%d %b %Y")%></div>
              </div>
              <div class="modal-footer" >
                <%= link_to "Update",  "#", :class=> "btn green", :id => "pass_student"%>
                <button type="button" class="btn default" data-dismiss="modal">Cancel</button>
              </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="student_remove" tabindex="-1" role="basic" aria-hidden="true">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title" id="del_modal_title">Remove Students</h4>
              </div>
              <div class="modal-body">
                Do you really want to remove selected students from this test?  
              </div>
              <div class="modal-footer" >
                <%= link_to "Confirm",  "javascript:;", :class=> "btn red", :id => "remove_student" %>
                <button type="button" class="btn default" data-dismiss="modal">Cancel</button>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 
<!--   <%# if current_admin_user.is_account_activated? %>
      
        <%#= form_tag manage_send_msg_preview_manage_path do %>
          <input type="hidden" id="send_message" name="stundent_ids"/>
          <%#= hidden_field_tag :award_test, @award_test.id %>
          <div class="col-sm-6">
            <label>Message to student</label>
            <%#= text_area_tag(:text_msg, nil,{:class => "form-control", :rows => 5, :cols => 20}) %>
            <div>
            <span style="float: left; margin-top: 10px; display: none; color: #E02222;" id="error_msg">You need to select at least 1 student to send your message.</span>
            <span style="float: left; margin-top: 10px; display: none;" id="successMsg"></span>
            <div class="text-right margin-top-10" style="float: right;">
              <%#= submit_tag "sad", {:class => "btn red", :id => "send_msg"} %>
            </div>
            </div>
          </div>  
        <%# end %>
      </div>
    </div>
  <%# end %> -->

  <% if current_admin_user.is_account_activated? %>
    <div class="row newSmsSend">
      <div class="col-sm-12">
        <%= form_tag (  manage_send_msg_preview_manage_path + "?isReqXhr=true"), remote: true, class: "sendMessages"  do %>
          <input type="hidden" id="send_message" name="stundent_ids"/>
          <input type="hidden" id="send_award" name="award_id" value="<%= @award_test.award_id %>"/>
          <input type="hidden" id="send_award_test" name="award_test_id" value="<%= @award_test.id %>"/>

          <div class="col-sm-6">
            <label>Message to student</label>
            <textarea class="form-control" cols="20" id="text_msg" name="text_msg" rows="5" onkeyup="textAreaAdjust(this)" style="overflow:hidden"></textarea>
            <%#= text_area_tag(:text_msg, nil,{:class => "form-control", :rows => 5, :cols => 20,:autocomplete => "off"}) %>
            <div>
              <span style="float: left; margin-top: 10px; display: none; color: #E02222;" id="error_msg">You need to select at least 1 student to send your message.</span>
              <span style="float: left; margin-top: 10px; display: none;" id="successMsg"></span>
              <div class="text-right margin-top-10" style="float: right; margin-bottom: 10px;">
                <%= submit_tag " Preview & Send", {:class => "btn red", :id => "send_msg"} %>
              </div>
            <br/>
            </div>
          </div>
        <% end %>

        <!-- <div class="col-sm-6 note note-info"> -->
        <!--   <h4 class="block" style="text-align: left;">Sending messages to students</h4>
          <p style="text-align: left;">
            Step 1: Use the checkbox to select the many students <br />
            Step 2: Type your message <br />
            Step 3: Click Send <br />
            <h4 class="block" style="text-align: left;" > 
              <p>Add <strong>&lt;student_name&gt;</strong> to send Student name in SMS.<br/>
              Add <strong>&lt;student_link&gt;</strong> to send Student Link in SMS.<br/>
              Add <strong>&lt;award_name&gt;</strong> to send Student Award Name in SMS.<br/>
              Add <strong>&lt;award_date&gt;</strong> to send Student Award Date in SMS.<br/>
              Add <strong>&lt;award_time&gt;</strong> to send Student Award Time in SMS.<br/>
              Add <strong>&lt;award_venue&gt;</strong> to send Student Award Venue in SMS.</p>
            </h4>
          </p> 
          </div>
          -->
            <div class="col-sm-6">
              <div class="note note-info">
                <h4 class="block">SMS Shortcodes</h4>
                <p>You may use the following shortcodes in this SMS.</p>
                <strong>&lt;student_link&gt;<br>&lt;award_name&gt;<br>&lt;award_date&gt;<br>&lt;award_time&gt;<br>&lt;award_venue&gt;
                </strong>
              </div>
            </div>
          </div>

      </div>
  <% end %> 

</div>
<div class="modal fade inst_student" id="inst_student" tabindex="-1" role="basic" aria-hidden="true"></div>

<script>

  jQuery(document).ready(function() { 
    SendSMSInGp.init();
  });
  jQuery(document).ready(function() { 
    $('#sample_2').dataTable({
          "aLengthMenu": [
              [5, 15, 20, -1],
              [5, 15, 20, "All"] // change per page values here
          ],
          "dom": '<toolbar>ftrip',
          // set the initial value
          "iDisplayLength": -1,
          "paging": false,
          "sPaginationType": "bootstrap",
          "oLanguage": {
            "sLengthMenu": "_MENU_ records",
            "oPaginate": {
                "sPrevious": "Prev",
                "sNext": "Next"
            },
            "sEmptyTable": "No student records"
           },
          "aoColumnDefs": [{
              'bSortable': true,
              'aTargets': [0]
            }
          ]
      });
      $('#sample_2_wrapper .dataTables_filter input').addClass("form-control input-xmedium input-inline"); // modify table search input
      $('#sample_2_wrapper .dataTables_length select').addClass("form-control input-xmedium input-inline"); // modify table per page dropdown

      $("#sample_2_wrapper").find(".table-scrollable").removeClass("table-scrollable");
      $('#award_test_table').sortable({
        axis: "y",
        containerSelector: 'table',
        itemPath: '> tbody',
        itemSelector: 'tr',
        placeholder: 'placeholder',
        update: function() {
          $.post($(this).data("update-url"), $(this).sortable("serialize"));
        }
      });
    $('#sample_2_length').append('<div class="btn-group bulk_dropdown" style="float: right;" ><button type="button" class="btn default default_value">Bulk Action</button><button type="button" class="btn default dropdown-toggle bulk_action_list" style="margin-left: -6px;" data-toggle="dropdown" disabled><i class="fa fa-angle-down"></i></button><ul class="dropdown-menu" role="menu"><li><a href="javascript:;" id="bulk_action">Confirmed</a></li><li><a href="#student_remove" data-toggle="modal" id="basicModalOpen" >Remove</a></li><li><a href="#student_status" id="baiscModalOpen" data-toggle="modal">Pass</a></li><li><a id="bulk_fail" href="javascript:;">Fail</a></li><li><a id="bulk_transfer" href="javascript:;">Transfer</a></li></ul></div>');

    $('<div class="row"><div class="col-md-12 col-sm-12"><table><tr ><td style="border: 1px solid #ddd; padding-left: 5px;"><strong> Award: </strong></td><td style="border: 1px solid #ddd; padding-left: 5px;"><%= !@award_test.award_id.blank? ? @award_test.award.name : '-' %></td></tr><tr><td style="border: 1px solid #ddd; padding-left: 5px;"><strong> Test Date : </strong></td><td style="border: 1px solid #ddd; padding-left: 5px;"><%= !@award_test.test_date.blank? ? @award_test.test_date.strftime("%e %b %Y") : "-" %></td></tr><tr><td style="border: 1px solid #ddd; padding-left: 5px;"><strong> Time :</strong></td><td style="border: 1px solid #ddd; padding-left: 5px;"><%= !@award_test.test_time.blank? ? @award_test.test_time.strftime("%I:%M %p") : "-"%></td></tr><tr><td style="border: 1px solid #ddd; padding-left: 5px;"><strong> Venue : </strong></td><td style="border: 1px solid #ddd; padding-left: 5px; padding-right: 5px;"><%= Venue.find(@award_test.venue_id).name%></td></tr></table></div></div><br/>').insertBefore('#sample_2_wrapper');
  });
  $(document).on("click", "#bulk_action", function(){
    var selected_student = $('#send_message').val();
    var award_test = '<%= @award_test.id %>';
    $('.default_value').text($(this).text());
    $.ajax({
      url: '<%= bulck_confirm_manage_award_test_path(@award_test.id) %>',
      type: 'POST',
      data: {student_list: selected_student, award_test_id: award_test }
    });
  });
  $(document).on("click", "#pass_student", function(){
    var selected_student = $('#send_message').val();
    var award_test = '<%= @award_test.id %>';
    $('.default_value').text($(this).text());
    $.ajax({
      url: '<%= bulck_pass_manage_award_test_path(@award_test.id) %>',
      type: 'POST',
      data: {student_list: selected_student, award_test_id: award_test }
    });
  });

  $(document).on("click", "#bulk_fail", function(){
    var selected_student = $('#send_message').val();
    var award_test = '<%= @award_test.id %>';
    $('.default_value').text($(this).text());
    $.ajax({
      url: '<%= bulk_fail_manage_award_test_path(@award_test.id) %>',
      type: 'POST',
      data: {student_list: selected_student, award_test_id: award_test }
    });
  });
  
  $(document).on("click", "#remove_student", function(){
    var selected_student = $('#send_message').val();
    var award_test = '<%= @award_test.id %>';
    $('.bulk_dropdown').text($(this).text());
    $.ajax({
      url: '<%= bulk_delete_manage_award_test_path(@award_test.id) %>',
      type: 'POST',
      data: {student_list: selected_student, award_test_id: award_test }
    });
  });

  $(document).on("click", "#bulk_transfer", function(){
    var selected_student = $('#send_message').val();
    var award_test = '<%= @award_test.id %>';
    var award_id=$('#send_award').val();
    $.ajax({
      url: '<%=  manage_award_test_list_bulk_path %>',
      type: 'GET',
      data: {student_list: selected_student, award_id: award_id }
    });
  });
</script>
<style type="text/css">
  @media print {
    .page-title{
      display: none;
    }
    .page-breadcrumb{
      display: none;
    }
    .portlet-title{
      display: none;
    }
    .portlet.box.green{
      border: none;
    }
    .col-md-6{
      display: none;
    }
    .col-sm-6{
      display: none;
    }
    .mycheckbox{
      display: none;
    }
    .dataTables_info{
      display: none;
    }
    .dropdown-toggle{
      display: none;
    }
    .fa{
      display: none;
    }
    .page-sidebar{
      display: none !important;
    }
    .page-sidebar-wrapper{
     display: none !important; 
    }
    .bnt_status{
     display: block !important; 
    }
    .btn-group{
     display: none !important; 
    }
    .td_date{
     width: 220px !important; 
    }
  }
</style>