<% days = [0,1,2,3,4,5,6] %>
<% title "Job Ref #{@job.id}" %>
<input type="hidden" value="<%= @job.id %>" id="job_h_id"></input>
<input type="hidden" value="<%= @job.tr_contact_id %>" id="job_h_lead_contact_id"></input>
<% if @job.is_apply_class? %>
  <% applyClass = true %>
<% else %>
  <% applyClass = false %>
<% end %>
<div class="row">
  <div class="col-md-12">
    <% if flash[:freshBookError] %>
      <div class="note note-danger">
        <strong>
          <%= flash[:freshBookError] %>
        </strong>
      </div>
    <% end %>
    <h3 class="page-title">
      <%= page_title %>
      <small>
        <%= page_description %>
      </small>
    </h3>
    <% if !@breadcrumbs.nil? %>
      <ul class="page-breadcrumb breadcrumb">
        <% @breadcrumbs.each do |breadcrumb| %>
          <li>
            <%= link_to(breadcrumb[:name], breadcrumb[:url]) %>
            <% if @breadcrumbs.last != breadcrumb %>
              <i class="fa fa-angle-right"></i>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>
</div>
<div class="row">
  <div class="col-md-12" style="padding-bottom: 5px;">
    <% if !@job_by_lead_contact.blank? %>
      <span style="width: 100%;">
        <div class="note note-warning">
          <p>
            <% cnts = 0 %>
            <% cnt = @job_by_lead_contact.count %>
            <% @job_by_lead_contact.each do |same_job| %>
              <% if same_job.id == @job_by_lead_contact.last.id %>
                <%= cnt != 1 ? "and" : "" %> <a href="<%= manage_job_path(same_job) %>">REF <%= same_job.id %></a> 
              <% else %>
                <a href="<%= manage_job_path(same_job) %>"> REF <%= same_job.id %></a>
              <% end %>
              <% cnts += 1 %>
              <% if cnt > 2 %>
                <% if cnt - 1  != cnts && cnt != cnts %>
                  ,
                <% end %>
              <% end %>
            <% end %>
            <%= cnt != 1 ? "are" : "is" %> from the same customer contract.
          </p>
          <%= link_to 'Send request for Feedback',manage_send_feedback_sms_path(@job),style: 'color: #E02222;',remote: true %>
        </div>
      </span>
    <% end %>
  </div>
  
  <%= render "add_payment" %>
  <%= render "delete_invoice"%> 
  <div class="col-sm-7">
    <!-- <a href="#" class="pull-right btn blue">Edit Lead</a> -->
    <div class="row">
      <div class="col-sm-6">
        <form action="" id="after_create_inv" name="after_create_invoice" target="_blank">
        </form>
        <span id="fb_invoices_tbl">
          <div class="generate_new_invoice">
          </div>
          <% if @job_freshbook_invoices.count > 0 %>
            <% if @job_freshbook_invoices %>
              <% @job_freshbook_invoices.each do |job_freshbook_invoice| %>
                <% if !job_freshbook_invoice.blank? %> 
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th colspan="2">
                            <% invoice =  Invoice.find_by_freshbooks_invoice_id(job_freshbook_invoice["invoice_id"]) if job_freshbook_invoice["invoice_id"] %>

                            <%= link_to "Invoice"  + job_freshbook_invoice["number"], job_freshbook_invoice["links"]["view"], :target => "_blank" %>
                            <div class="btn-group pull-right">
                            <a href="javascript:;" data-href="<%= manage_invoice_update_invoice_path(invoice.id, @job.id) %>" class="btn default btn-xs update_invoice" id="update_invoice" class="add_payment"> 
                                Update
                            </a>

                            <% if job_freshbook_invoice["paid"].to_i > 0 %>
                              <a class="delete_invoice btn red btn-xs" data-toggle="modal" href="#deletePayment">Delete </a>
                            <% else %>
                              <a data-toggle="modal" id="basicModalOpen" href="#basic" data-invoice_id="<%= job_freshbook_invoice["invoice_id"] %>" data-invoice_number="<%= job_freshbook_invoice["number"] %>" class="delete_invoice btn red btn-xs">Delete</a>
                            <% end %>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody id="fb_invoices">
                        <tr id="invoice-timer-tr">
                          <% if @invoice_time.blank? %>
                            <td>No Timer set</td>
                            <td><%= link_to "Edit" , manage_reset_invoice_time_popup_path(@invoice) , class:' btn btn-primary' , remote: true %></td>
                          <% else %>
                            <td id="invoice-timer" class="invoice-timer">
                              <%= hidden_field_tag "invoice_time", (@invoice_time - Time.zone.now)   , { :id => "invoice_time" } %></td>
                            <td><%= link_to "Edit" , manage_reset_invoice_time_popup_path(@invoice) , class:' btn btn-primary' , remote: true %></td>
                          <% end %>
                        </tr>
                        <tr>
                          <td>Status</td>
                          <td>
                            <%= job_freshbook_invoice["status"].capitalize %>
                            <% if job_freshbook_invoice["status"].capitalize == 'Draft' %>
                              &nbsp;<span class="glyphicon glyphicon-warning-sign" aria-hidden="true" style="color: red;"></span>
                            <% end %>
                          </td>
                        </tr>
                        <tr>
                          <td>Total</td>
                          <td>$ <%= job_freshbook_invoice["amount"] %></td>
                        </tr>
                        <tr>
                          <td>Paid</td>
                          <td>$ <%= job_freshbook_invoice["paid"] %></td>
                        </tr>
                        <tr>
                          <td colspan="2">
                            <a id="generateInvoiceSMS" href="javascript:;" onclick="generateInvoiceSms('<%= view_pa_path(@job.id, invoice.u_sec_number) %>');" data-invoice_id="<%= job_freshbook_invoice["invoice_id"] %>" data-invoice_number="<%= job_freshbook_invoice["number"] %>" class="delete_invoice btn blue btn-sm">Generate SMS</a>
                            <div class="btn-group">
                              <%# if job_freshbook_invoice["status"].capitalize != "Paid" %>
                                <a href="<%= view_pa_path(@job.id, invoice.u_sec_number) %>" class="btn default btn-xs" id="sms_payment" target="_blank" class="add_payment">View PA</a>
                              <%# end %>                              
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                <%end%>
              <%end%>
            <%end%>
          <%end%>
        </span>
      </div>
      <!-- START : FOR PAYMENT STATUS DETAIL ON INVOICES -->    
      <div class="col-sm-6">
        <% if @payment_notifications.count > 0 %>
          <div class="table-responsive">
            <h3>Transaction</h3>
                <% @payment_notifications.each do |payment_notification| %>
                  <%@manual_payment = ManualPayment.find_by(local_payment_id: payment_notification.id.to_s)%>
                <table class="table table-bordered">
                  <tr>
                    <td>Source</td>
                    <td><%= payment_notification.paid_by %></td>
                  </tr>
                  <tr>
                    <td>Amount</td>
                    <td>
                      <% if !payment_notification.amount.blank?  %>
                        <%= "$" + payment_notification.amount.to_s %>
                      <% end %>
                    </td>
                  </tr>
                  <tr>
                    <td>Status</td>
                    <td><%= payment_notification.status %></td>
                  </tr>
                  <tr>
                    <%if payment_notification.status != "Rejected" && payment_notification.status != "Completed" && !@manual_payment %>
                    <%#if payment_notification.status == "Completed" || payment_notification.status == "Paid" %>
                      <td colspan="2"><%= link_to 'Add Payment', manage_add_payment_status_path(@job.id, payment_notification.id), :id => "addpayment" %></td>
                    <% end %>
                  </tr>
                </table>
              <% end %> 
          </div>
        <% end %>
      </div>
      <div class="col-sm-12">
        <% if @job_freshbook_invoices.count > 0 %>
          <div>
          <%# if @manual_job_payments.count > 0 %>
            <div class="table-responsive">
              <h3>Manual Payment</h3>
                <div class="row">
                  <%= form_tag manage_add_manual_payment_path(@job.id), method: :POST do %>
                    <div class="col-xs-4 col-xs-offset-2">  
                      <div class="input-group input-medium date date-picker">
                        <% if @date.nil? %>
                          <input type="text" class="form-control" readonly style="width: 60%; height: 34px" id="payment_date" name="date_payment" value="<%= Date.today.strftime("%d %b %Y") %>">
                        <% else %>
                          <input type="text" class="form-control" readonly style="width: 60%; height: 34px" id="payment_date" name="date_payment" value="<%= @date %>">
                        <% end %>
                          <button class="btn default" type="button" style="width: 20%; height: 34px;"><i class="fa fa-calendar"></i></button>
                      </div>
                    </div>
                    <div class="col-xs-2">
                    <%= submit_tag "Add", :class => " btn blue" %>
                    </div>
                  <% end %>
                  <%= form_tag manage_add_manual_payment_path(@job.id), method: :POST do %>
                    <% if @job.start_date? %>
                      <input type="hidden" id="start_date" name="start_date" value="<%= @job.start_date %>">
                    <% end %>
                    <% if @job.fee_total? && @job.referral? %>
                      <input type="hidden" id="Balance" name="balance" value="<%= @job.fee_total - @job.referral %>">
                    <% else %>
                      <input type="hidden" id="Balance" name="balance" value="<%= @job.fee_total %>">
                    <% end %>
                    <input type="hidden" id="payment_method" name="payment_method" value="Cash">
                    <div class="col-xs-2 add_balance">
                      <%= submit_tag "Add Balance", :class => " btn blue" %>
                    </div>
                  <% end %>
                </div>

              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Referral</th>
                    <th>Balance</th>
                    <th>Payment Method</th>
                    <th>Notes</th>
                    <th>Invoice</th>
                   <!--  <th>Status</th> -->
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                <%session[:job_id] = @job.id%>
                 <% @manual_job_payments.each do |manual_job_payment| %>
                    <% if manual_job_payment.committed? && !manual_job_payment.payment_id.blank? %>
                      <% isCommited = "none" %>
                    <% else %>
                      <% isCommited = "initial" %>
                    <% end %>
                  <tr>
                    <td>
                    <%# if manual_job_payment.payment_date.present? %>
                      <%#= manual_job_payment.payment_date %>
                    <%# else %>
                      <%= manual_job_payment.payment_date %>
                    <%#end %>
                    </td>
                    <td>
                      <a href="javascript:;" id="editReferral_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :referral, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editReferral_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputReferral" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                    <% if manual_job_payment.balance.present? %>
                      <a href="javascript:;" id="editBalance_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :balance, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editBalance_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputBalance" , :class => "manual_status_payment"%>
                    <% else %>
                      <a href="javascript:;" id="editBalance_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :balance, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editBalance_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputBalance" , :class => "manual_status_payment"%>
                    <%end %>
                    </td>
                    <td>
                    <% if manual_job_payment.payment_method.present? %>
                      <a href="javascript:;" id="editPaymentMethod_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :payment_method, :type => :select, :collection => [['', ''], ['Bank Transfer', 'Bank Transfer'], ['Cash', 'Cash'],['Check','Check'],['Paypal','Paypal'],['Credit Card','Credit Card']], :include_blank => true, :path => [ :manage, manual_job_payment ],  :path => [ :manage, manual_job_payment ],:activator => "#editPaymentMethod_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputpaymentmethod" , :class => "manual_status_payment"%>
                    <% else %>
                      <a href="javascript:;" id="editPaymentMethod_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :payment_method, :type => :select, :collection => [['', ''], ['Bank Transfer', 'Bank Transfer'], ['Cash', 'Cash'],['Check','Check'],['Paypal','Paypal'],['Credit Card','Credit Card']], :include_blank => true, :path => [ :manage, manual_job_payment ],  :path => [ :manage, manual_job_payment ],:activator => "#editPaymentMethod_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputpaymentmethod" , :class => "manual_status_payment"%>
                    <% end %>
                    </td>
                    <td>
                      <a href="javascript:;" id="editDescription_<%= manual_job_payment.id %>" style="display: <%= isCommited %>" ><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :description, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editDescription_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputpaymentdescription" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                      <% if @job.invoices.blank? %>
                        <span>-</span>
                      <% elsif @job.invoices.count == 1 %>
                        <%= manual_job_payment.invoice_number %>
                      <% elsif @job.invoices.count > 1 %>
                        <a href="javascript:;" id="editInvoice_<%= manual_job_payment.id %>" style="display: <%= isCommited %>" ><i class="fa fa-pencil"></i></a>
                          <%= best_in_place manual_job_payment, :invoice_number, :type => :select, :collection => @job.invoices.map { |p| [p.invoice_number.to_s, p.invoice_number.to_s] }, :path => [:manage, manual_job_payment],:activator => "#editInvoice_#{manual_job_payment.id}", inner_class: "form-control editInvoice" %>
                      <% end %>
                    <!-- </td>
                    <%# if manual_job_payment.committed == true %>
                      <td>Committed</td>
                      <%# elsif %>  
                      <td>Uncommitted</td>
                    <%# end %> -->
                    <td>
                      <% if manual_job_payment.committed? && !manual_job_payment.payment_id.blank? %>
                        <%= link_to "Uncommit", remove_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s %>
                      <% elsif manual_job_payment.committed? && manual_job_payment.payment_id.blank? %>
                        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s, style: "display: none;" %>              
                      <% else %>
                        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s %>
                      <% end %>
                      <%= link_to " Edit", edit_manage_manual_payment_path(manual_job_payment), :target => "_blank",style: "font-size: 13px;"  %>
                    </td>
                  </tr>
                 <% end %> 
                </tbody>
              </table>
            </div>
          <%# end %>
          </div>
        <% else %>
          <% if @manual_job_payments.count > 0 %>
            <div class="table-responsive">
              <h3>Manual Payment</h3>
                <div class="row">
                  <%= form_tag manage_add_manual_payment_path(@job.id), method: :POST do %>
                    <div class="col-xs-4 col-xs-offset-4">  
                      <div class="input-group input-medium date date-picker">
                        <% if @date.nil? %>
                          <input type="text" class="form-control" readonly style="width: 60%; height: 34px" id="payment_date" name="date_payment" value="<%= Date.today.strftime("%d %b %Y") %>">
                        <% else %>
                          <input type="text" class="form-control" readonly style="width: 60%; height: 34px" id="payment_date" name="date_payment" value="<%= @date %>">
                        <% end %>
                          <button class="btn default" type="button" style="width: 20%; height: 34px;"><i class="fa fa-calendar"></i></button>
                      </div>
                    </div>
                    <div class="col-xs-2">
                    <%= submit_tag "add", :class => " btn blue" %>
                    </div>
                  <% end %>
                </div>

              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Referral</th>
                    <th>Balance</th>
                    <th>Payment Method</th>
                    <th>Notes</th>
                    <th>Invoice</th>
                   <!--  <th>Status</th> -->
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                <%session[:job_id] = @job.id%>
                 <% @manual_job_payments.each do |manual_job_payment| %>
                    <% if manual_job_payment.committed? && !manual_job_payment.payment_id.blank? %>
                      <% isCommited = "none" %>
                    <% else %>
                      <% isCommited = "initial" %>
                    <% end %>
                  <tr>
                    <td>
                    <%= manual_job_payment.payment_date %>
                    </td>
                    <td>
                      <a href="javascript:;" id="editReferral_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :referral, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editReferral_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputReferral" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                      <a href="javascript:;" id="editBalance_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :balance, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editBalance_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputBalance" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                      <a href="javascript:;" id="editPaymentMethod_<%= manual_job_payment.id %>" style="display: <%= isCommited %>"><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :payment_method, :type => :select, :collection => [['', ''], ['Bank Transfer', 'Bank Transfer'], ['Cash', 'Cash'],['Check','Check'],['Paypal','Paypal'],['Credit Card','Credit Card']], :include_blank => true, :path => [ :manage, manual_job_payment ],  :path => [ :manage, manual_job_payment ],:activator => "#editPaymentMethod_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputpaymentmethod" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                      <a href="javascript:;" id="editDescription_<%= manual_job_payment.id %>" style="display: <%= isCommited %>" ><i class="fa fa-pencil"></i></a>
                        <%= best_in_place manual_job_payment, :description, :as => :input, :path => [ :manage, manual_job_payment ],:activator => "#editDescription_#{manual_job_payment.id}", inner_class: "form-control paymentAmount bestinplaceInputpaymentdescription" , :class => "manual_status_payment"%>
                    </td>
                    <td>
                      <% if @job.invoices.blank? %>
                        <span>-</span>
                      <% elsif @job.invoices.count == 1 %>
                        <%= manual_job_payment.invoice_number %>
                      <% elsif @job.invoices.count > 1 %>
                        <a href="javascript:;" id="editInvoice_<%= manual_job_payment.id %>" style="display: <%= isCommited %>" ><i class="fa fa-pencil"></i></a>
                          <%= best_in_place manual_job_payment, :invoice_number, :type => :select, :collection => @job.invoices.map { |p| [p.invoice_number.to_s, p.invoice_number.to_s] }, :path => [:manage, manual_job_payment],:activator => "#editInvoice_#{manual_job_payment.id}", inner_class: "form-control editInvoice" %>
                      <% end %>
                    <!-- </td>
                    <%# if manual_job_payment.committed == true %>
                      <td>Committed</td>
                      <%# elsif %>  
                      <td>Uncommitted</td>
                    <%# end %> -->
                    <td>
                      <% if manual_job_payment.committed? && !manual_job_payment.payment_id.blank? %>
                        <%= link_to "Uncommit", remove_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s %>
                      <% elsif manual_job_payment.committed? && manual_job_payment.payment_id.blank? %>
                        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s, style: "display: none;" %>              
                      <% else %>
                        <%= link_to "Commit", add_payment_manage_manual_payment_path(manual_job_payment), :remote => true, :class => "manual_payment", :id => "manual_payment_add_"+manual_job_payment.id.to_s %>
                      <% end %>
                      <%= link_to " Edit", edit_manage_manual_payment_path(manual_job_payment), :target => "_blank",style: "font-size: 13px;"%>
                    </td>
                  </tr>
                 <% end %> 
                </tbody>
              </table>
            </div>
          <% end %>          
        <% end %>
      </div>

       
      <!-- END : FOR PAYMENT STATUS DETAIL ON INVOICES  -->
      <div class="col-md-12" style="margin-bottom: 5px;">
        <a class="pull-left" data-toggle="modal" href="#print">Print </a>
        <div class="modal fade bs-modal-sm in print_label" id="print" tabindex="-1" role="basic" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <%= form_tag manage_generate_pdf_job_path(@job), :target=>"_blank" do %>
              <div class="modal-content">
                <div class="modal-body print">
                  <center>Singapore<strong>Swimming</strong>Academy</center>
                  <div class="row">
                    <div class="col-md-12">
                      <h4>Name</h4>
                      <input type="text" class="col-md-12 form-control" value="<%= @job.lead_name%>" name="lead_name" id="print_name">
                    </div>
                    <div class="col-md-12">
                      <div class="pull-left">
                      <h4>Address</h4></div><a href="javascript:;" onclick="autoFillPdfData();" class="pull-right" style="margin-top: 10px;">Autofill to coach</a>
                      <textarea class="col-md-12 form-control" value="" name="lead_address" id="print_address" rows="4"><%= @job.lead_address %></textarea>
                    </div>
                    <div class="col-md-12">
                      <h4>Quantity</h4>
                      <input type="text" class="col-md-12 form-control" id="print_quantity" name="quantity" value="<%= @job.students.count %>">
                    </div><br/>
                  </div>
                  <div class="row">
                    <div class="col-md-12"><br/>
                      <center>
                        <button type="submit" class="btn blue" id="printPdf">Generate PDF</button>
                        <!-- <a href="javascript:;" class="btn blue" onclick="ClickHereToPrint();">Print</a> -->
                        <button type="button" class="btn default" data-dismiss="modal">Close</button>
                      </center>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        <a href="<%= manage_edit_lead_path(@job.id) %>" class="pull-right">Edit Lead</a>
      </div>
      <div class="col-md-6">
        <table class="table table-bordered table-striped" id="user" style="font-size: 14px;">
          <tbody>
            <tr>
              <td style="width:30%">Name</td>
              <td style="width:70%">
                <%= @job.lead_name %>
              </td>
            </tr>
            <tr>
              <td style="width:30%">Contact</td>
              <td style="width:70%" id="lead_contact">
                <%= @job.lead_contact %>
              </td>
            </tr>
            <tr>
              <td style="width:30%">Email</td>
              <td style="width:70%" id="lead_email" style="word-break: break-all;">
                <%= @job.lead_email %>
              </td>
            </tr>
            <tr>
              <td style="width:30%">Student(s)</td>
              <td style="width:70%">
                <% if @job.students.count == 0 %>
                  <a href="#" class="btn btn-xs red disabled"> <i class="fa fa-life-ring"></i>No Student Found</a>
                <% else %>
                  <input type="hidden" value="<%= @job.students.count %>" id="StudentCount"></input>
                  <% @job.students.each do |student| %>
                    <%= student.name %>
                    <% if student.age? %>
                      <%= "-"  %>
                      <%= student.age %>yrs
                      <% if !student.age_month.blank? && student.age_month != 0  %>
                        <%= student.age_month %>mths
                      <% else %>
                        old
                      <% end %>  
                    <% end %>  
                    <%= "(" if student.sex? %><%= student.sex %><%= ")" if student.sex? %>
                    <br/>
                  <% end %>
                <% end %>
              </td>
            </tr>
            <tr>
              <td style="width:30%">Address</td>
              <td style="width:70%" id="lead_address">
                <%= @job.lead_address %>
              </td>
            </tr>
            <tr>
              <td style="width:30%">Referred From</td>
              <td style="width:70%"><a href="<%= @job.lead_affiliate %>" title="<%= @job.lead_affiliate %>">Link</a></td>
            </tr>
            <tr>
              <td style="width:30%">Referred</td>
              <td style="width:70%"><%= @job.referred %></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-bordered table-striped" id="user">
          <tbody>
            <tr>
              <td style="font-size: 14px;">
                <strong>Class Type :</strong>
                <%= ClassType.find(@job.lead_class_type).title if @job.lead_class_type? %>
                <br>
                <strong>Venue</strong><br/>
                <p>
                <% if @job.lead_class_type? %>  
                  <% if ClassType.find(@job.lead_class_type).title.capitalize == "Private" %>
                    <% if !@job.other_venue.blank? %>
                    - Condo: <%= @job.other_venue %><br>
                    <% elsif !@job.private_lesson_venue_id.blank?%>
                    - <%= Venue.find(@job.private_lesson_venue_id).name if !@job.private_lesson_venue_id.blank? %><br>
                    <% end %>
                  <% else %>
                    <% if @job.venues.count > 0 %>
                      <% @job.venues.each do |venue| %>
                        - <%= venue.name %><br>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
                </p>

                <strong>Preferred Day/time</strong><br/>
                <% if @job.lead_class_type? %>  
                  <%# if ClassType.find(@job.lead_class_type).title.capitalize == "Private" %>
                    <%# @job.preferred_days.each do |pf| %>
                      <%# if !pf.day.blank? && !pf.preferred_time.blank? %>
                        <%#= @day_array[pf.day] %> - <%#= pf.preferred_time.strftime("%l:%M %P") %> <br/> 
                      <%# end %>  
                    <%# end %>
                  <%# else %>
                    <%= simple_format(@job.lead_day_time).html_safe %>
                  <%# end %>
                <% end %>    
                <strong>Starting:</strong><% if !@job.lead_starting_on.nil? %>
                  <%= @job.lead_starting_on.strftime("%d %B %Y") %><br/><br/>
                <% end %>

                <% if !@job.registration_package_id.nil?%>
                  <% registration_package = RegistrationPackage.find(@job.registration_package_id) %>
                  <strong>Package Detail</strong><br>
                  Coach : <%= registration_package.is_lady? ? "Lady" : "Male"  %><br/>
                  No. of student : <%= registration_package.no_of_student  %><br/>
                  Price : $<%= registration_package.price.to_i  %><br/><br/>
                <% end %>
                
                <% if @job.lead_lady_instructor_only == true %>
                  <strong>Lady instructor preferred</strong><br>
                <% end %>
                
                <strong>Additional Info</strong><br>
                <%= simple_format(@job.lead_info).html_safe %>
                
                <% if !@job.is_insurance.nil? %>
                  <% if @job.is_insurance == true %>
                    <strong>Insurance : </strong>yes
                  <% end %>
                <% end %>  
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <br/>
    <div class="clearfix"></div>
    <div class="row">
      <%= render :partial => "manage/jobs/customer_conversations" %>
      <%= render :partial => "manage/jobs/instructor_conversations" %>
    </div>
  </div>

  <div class="col-sm-5">
    
    <div class="portlet box blue-madison">
      <div class="portlet-title">
        <div class="caption">
          <i class="fa fa-gift"></i>
          Edit Job
        </div>
      </div>
      <div class="portlet-body form">
        <%= semantic_form_for [:manage, @job],:html => { :id => "job_edit" }, :remote => true  do |f| %>
          <textarea id="save_inst_message" name="save_inst_message" style="display: none;"></textarea>
          <textarea id="save_cust_message" name="save_cust_message" style="display: none;"></textarea>
          <div class="form-body">
            <!-- <div class="clearfix">
              <span class="help-inline">
                <div class="btn-group" data-toggle="buttons">
                  <%# ["New", "Post", "Suggest", "Invoice", "Receipt", "Delete"].each do |item| %>
                    <%# if @job.job_status == item %>
                      <%# if item == "Delete" %>
                        <label class="btn blue-default red active">
                      <%# else %>
                        <label class="btn blue-default blue-madison active">
                      <%# end %>  
                        <%#= f.radio_button :job_status, item, :class=>"toggle" ,:required => true %>
                        <%#= item %>
                      </label>
                    <%# else %>
                      <label class="btn btn-default">
                        <%#= f.radio_button :job_status, item, :class=>"toggle" ,:required => true %>
                        <%#= item %>
                      </label>
                    <%# end %>
                  <%# end %>
                </div>
              </span>
            </div> -->
            <div class="row">
              <div class="col-md-12">
                <%= f.label :job_status, "Job Status" %>
                <div class="form-group">
                  <%= f.collection_select :job_status, @job_status, :to_s, :to_s, { :include_blank => false}, {:class => "form-control"} %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6" data-name = "venue_name">
                <%= f.label :venue_id, "Venue" %>
                <div class="form-group">
                  <%= f.collection_select :venue_id, Venue.all, :id, :name, { :include_blank => true}, {:class=>"form-control venue"} %>
                </div>
              </div>
              
              <div class="col-md-6" data-name="class_type">
                <%= f.label :class_type %>
                <div class="form-group">
                  <%= f.collection_select :class_type, ClassType.all, :id, :title, { :include_blank => true}, {:class=>"form-control" } %>
                </div>
              </div>
              
            </div>
            <div class="row" id="group_only">
              <div class="col-md-6" data-name="age_group">
                <%= f.label :age_group %>
                <div class="form-group">
                  <%= f.collection_select :age_group, AgeGroup.all, :id, :title, { :include_blank => true}, {:class=>"form-control age_group"} %>
                </div>
              </div>
              <!-- /span -->
              <div class="col-md-6" data-name="class_level">
                <%= f.label :class_level %>
                <div class="form-group">
                  <%= f.collection_select :class_level, Level.all, :id, :title, { :include_blank => true}, {:class=>"form-control"} %>
                </div>
              </div>
              <!-- /span -->
            </div>
            <div class="row">
              <div class="col-md-12">
                <center><button class="btn blue-madison btn-sm" type="button" id="search_group" data-toggle='modal' data-target='#large'>Search Group</button></center>
              </div>
            </div>

            <div class="gc_by_venue">
              <!-- <br><center> <img src='/assets/input-spinner.gif' alt='loading' class='spin'></center> -->
              <%= render partial: "manage/group_classes/group_class_by_venue" %>
            </div>

            <div class="form-group">
              <div class="text input optional form-group" id="job_preferred_time_input" data-name="preferred_time">
                <label class="control-label" for="job_preferred_time">Preferred Time</label>
                <span class="form- wrapper">
                  <% if @job.preferred_time? %>
                    <%= f.text_area :preferred_time, :rows => 3, :class => "form-control", :placeholder => 'Preferred Time.', :value => "#{@job.preferred_time.gsub(/\r\n/,"%-%").split("%-%").join("\r")}" %>
                  <% else %>
                    <%= f.text_area :preferred_time, :rows => 3, :class => "form-control", :placeholder => 'Preferred Time.' %>
                  <% end %>
                </span>
              </div>
            </div>
            <div class="form-group" id="other_venue_block" data-name="s_job_other_venue">
              <div class="text input optional form-group" id="job_other_venue_input">
                <span class="form- wrapper">
                  <%= f.input :other_venue, :class => "form-control", :placeholder => 'Other Venue.' %>
                </span>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8"></div>
              <div class="col-md-4">
                <a href="javascript:;" class="btn btn-xs red removeClassGp" <%= @job.is_apply_class? ? "" : "disabled" %>>Remove class</a>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4" data-name="day_of_week">
                <div class="form-group">
                  <label class="control-label" for="job_class_time">Day of week</label>
                  <%= f.select :day_of_week, [["Monday", 1], ["Tuesday",2], ["Wednesday", 3], ["Thursday", 4], ["Friday", 5], ["Saturday" , 6], ["Sunday" , 0]], {}, :class => "form-control #{applyClass}", disabled: applyClass %>
                </div>
              </div>
              
              <div class="col-md-4" data-name="class_time">
                <div class="form-group">
                  <label class="control-label" for="job_class_time">Class Time</label>
                  <% if applyClass == true %>
                    <input class="form-control" data-date-format="hh:mm A/PM" id="job_class_time" name="job[class_time]" type="text" disabled="<%= applyClass %>">
                  <% else %>
                    <input class="form-control" data-date-format="hh:mm A/PM" id="job_class_time" name="job[class_time]" type="text">
                  <% end %>
                </div>
              </div>
              <div class="col-md-4" data-name="duration">
                <div class="form-group">
                  <label class="control-label" for="job_duration">Duration (mins)</label>
                  <%= f.text_field :duration, :class => "form-control", disabled: applyClass %>
                </div>
              </div>
              
            </div>
            <div class="row">
              <div class="col-md-6" data-name="start_date">
                 <label class="control-label">Start date</label>
                <br/>
                <% if @job.start_date? %>
                  <%= f.text_field :start_date, :class => "form-control date-picker", :value => "#{@job.start_date.strftime('%e %B %Y')}", :readonly => true,:style=> "background-color: #eee !important;" %>
                <% else %>
                  <%= f.text_field :start_date, :class => "form-control date-picker", :readonly => true,:style=> "background-color: #eee !important;" %>
                <% end %>
              </div>
              
              <div class="col-md-6" data-name="fee_type">
                <label class="control-label">Fee Type</label>
                  <%= f.collection_select :fee_type_id, FeeType.all, :id, :name, { :include_blank => true}, {:class=>"form-control", disabled: applyClass} %>
                  <%# ["Per Month", "Per Course"].each do |a| %>
                    <%#= f.radio_button :fee_structure, a, :checked => (a == "Per Month"), :id => "chk-#{a}" %>
                    <%#= f.label a, :for => "chk-#{a}" %>
                    <br/>
                  <%# end %>
              </div> 
              
            </div>
            <div class="row" id="fee_structure_wise" data-name="completed_by">
              <div class="col-md-6">
                <div class="form-group">
                  <%= f.label :completed_by %>
                  <br/>
                  <% if @job.completed_by? %>
                    <%= f.text_field :completed_by, :class => "form-control date-picker", :value => "#{@job.completed_by.strftime('%e %B %Y')}", :readonly => true,:style=> "background-color: #eee !important;" %>
                  <% else %>
                    <%= f.text_field :completed_by, :class => "form-control date-picker", :readonly => true,:style=> "background-color: #eee !important;" %>
                  <% end %>
                </div>
              </div>

              <div class="col-md-6" data-name="lesson_count">
                <div class="form-group">
                  <label for="lesson_count">Lesson Count</label>
                  <div class="input-group">
                    <%= f.text_field :lesson_count, :placeholder => "e.g. 10", :class => "form-control", disabled: applyClass %>
                    <span class="input-group-addon btn blue" id="count_lesson">
                      Count
                    </span>
                  </div>
                </div>
              </div>
              
            </div>
            <div class="row">
              <div class="col-md-4" data-name="per_pax">
                <div class="form-group">
                  <label for="lesson_count">Per Pax</label>
                  <%= f.text_field :par_pax, :placeholder => "e.g. 60", :class => "form-control" %>
                </div>
              </div>
              <div class="col-md-4" data-name="fee_total">
                <div class="form-group">
                 <label for="lesson_count">Fee Total</label>
                    <%= f.text_field :fee_total, :placeholder => "e.g. $30", :class => "form-control" %>
                </div>
              </div>
              <div class="col-md-4" data-name="referral">
                <div class="form-group">
                  <label for="lesson_count">Referral</label>
                  <%= f.text_field :referral, :placeholder => "e.g. 120",:class => "form-control" %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8" data-name="instructor_name">
                <div class="form-group">
                  <label for="lesson_count">Instructor</label>
                  <%= f.collection_select  :instructor_id,  Instructor.order('name ASC'), :id, :instructor_name_and_mobile , { :include_blank => 'Please Select' }, { :class=>"form-control" ,:required => true, disabled: applyClass } %>
                </div>
              </div>
              <!-- <div class="col-md-4">
                <a href="javascript:;"  class="btn default" id="viewClass" data-toggle='modal' data-target='#large'>
                  Show Classes
                </a>
              </div> -->
            </div>
            <div class="form-group">
              <div class="text input optional form-group" id="job_coordinator_notes">
                <label class="control-label" for="coordinator_notes" data-name="coordinator_notes">Coordinator Notes</label>
                <span class="form- wrapper">
                  <%= f.text_area :coordinator_notes, :rows => 3, :class => "form-control", :placeholder => 'Coordinator Notes.' %>
                </span>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8">
                <div class="form-group">
                  <span data-name="show_names"><%= f.input :show_names %></span>
                  <span data-name="free_goggles"><%= f.input :free_goggles %></span>
                  <span data-name="lady_instructor"><%= f.input :lady_instructor %></span>
                </div>
              </div>
            </div>
            <div class="row" id="goggal_status_attend" >
              <div class="col-md-6">
                <div class="form-group">
                  <%= f.label :first_attendance %>
                  <br/>
                  <%= f.select :first_attendance, [ 'Attended' ],{ :include_blank => true},{:class=>"form-control" }   %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <%= f.label :goggles_status %>
                  <br/>
                  <%= f.select :goggles_status, [ 'By hand','Coach','Dispatched','No goggles' ],{ :include_blank => true},{:class=>"form-control" }   %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8">
                <legend>Payment Related</legend>
                <div class="form-group">
                  <span>
                    <%= f.check_box :bank_transfer %>
                    <%= f.label :bank_transfer %>
                  </span>
                  </br>
                  <span>
                    <%= f.check_box :request_full_payment %>
                    <%= f.label :request_full_payment %>
                  </span>
                  <br>
                  <span>
                    <% if @job.allow_paypal.nil? %>
                      <%= f.check_box :allow_paypal, :checked => true %>
                    <% else %>
                      <%= f.check_box :allow_paypal %>
                    <% end %>
                    <%= f.label :allow_paypal %>
                  </span>
                  <br>
                  <span>
                    <%= f.check_box :allow_xfers %>
                    <%= f.label :allow_xfers %>
                  </span>
                  <br>
                  <span>
                    <%= f.check_box :allow_red_dot %>
                    <%= f.label :allow_red_dot, "Visa or Mastercard" %>
                  </span>
                  <br>
                  <span>
                    <%= f.check_box :enets %>
                    <%= f.label :enets, "eNETS" %>
                  </span>
                </div>
              </div>
              <div class="col-md-8">
                <legend>Terms and Condition</legend>
                <div class="form-group">
                  <div class="field">
                    <%= hidden_field_tag("job[terms_and_condition_ids][]", nil) %>
                      <% TermsAndCondition.where(:status => "Active").each do |terms_condition| %>
                        <label>
                          <%= check_box_tag "job[terms_and_condition_ids][]", terms_condition.id, @job.terms_and_conditions.include?(terms_condition), {:class => "terms_and_condition", :id => "T#{terms_condition.id}"} %>
                          <%= terms_condition.title %>
                        </label><br/>
                      <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-actions fluid">
            <div class="col-md-offset-1 col-md-12">
            <% if @job_freshbook_invoices.count == 0  %>
              <a class="btn green" id="create_invoice" >Create Invoice</a>
            <% else %>
              <a class="btn green" id="create_invoice" disabled = "true">Create Invoice</a>
            <% end %>
              <%= link_to "Generate SMS", "javascript:void(0);", :class => "btn blue ajaxify", :id => "generate_sms" %>
              <%= f.submit 'Save', :class => "btn green" , :id=> "save_job"%>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<div class="modal add_payment_error fade bs-modal-sm" id="my_error" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body"></div>
      <div class="modal-footer" style="border-top: none !important;">
        <button type="button" class="btn default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div id="reset-time-window" class="modal fade reset-time-window" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>

<script>

  // var instructor = $("#job_instructor_id").find('option:selected').text();
  // instructor = $.trim(instructor.substring(0, instructor.indexOf('(')));
  // var nil = "";
  // if(instructor != ""){
  //   $.ajax({
  //     url: '/manage/job_conversation',
  //     type: 'GET',
  //     dataType: 'json',
  //     data: { instructor: instructor },
  //     beforeSend : function(){
  //       $("#instructor_conversation").html('<li style="margin-top: 60%;"><div class="panel panel-success"><div class="panel-heading"><h4 class="panel-title">Loading...</h4></div></div></li>');
  //     }
  //   })
  //   .done(function(data) {
  //     if($("#instructor_conversation_load_msg").is(":visible")){
  //       $("#instructor_conversation_load_msg").remove();
  //     }
  //     showConversation(data, "instructor_conversation")
  //     $('.inst_scroller').animate({scrollTop: $('#instructor_conversation li:last-child').position().top}, 'slow');
  //     var inst_number = data.mobile;
  //     $("#inst_number").html(inst_number);
  //   });
  //  } 
  // else {
  //   var error_msg = '<li><div class="panel panel-danger"><div class="panel-heading"><h4 class="panel-title">No conversation found</h4></div></div></li>';
  //   $("#instructor_conversation").html(error_msg);
  // }
  var flag_s = 0;
  var instructor_name_val_s = $("#job_instructor_id option:selected").text();
  
  if(instructor_name_val_s == "Please Select" || instructor_name_val == ""){
  }
  else {

    instructor_name_val_s = $.trim(instructor_name_val_s.substring(0, instructor_name_val_s.indexOf('-')));
    console.log(instructor_name_val_s);
    $.ajax({
      url: '/manage/get_instructor?short_nm=true',
      type: 'get',
      data: { instructor: instructor_name_val_s },
     })
     .done(function(data) {
        $("#job_instructor_id option:selected").attr({"data-shortname":data});
     });
  }
  $("#save_job").click(function(){
    $("#save_inst_message").val($("#instructor_message_template").val());
    $("#save_cust_message").val($("#customer_message_template").val());
  });

// $("#job_par_pax_input").attr("data-name","per_pax");
// Job Preferred Time Hide/Show according to job status
  $(document).ready(function(){

    // var unsaved = false;
    // $('input:not(:submit),textarea,select').change(function(){ //trigers change in all input fields including text type
    //     unsaved = true;
    // });
    // $('input:submit').click(function(e) {
    //     unsaved = false;
    //   });
    // function unloadPage(){ 
    //     if(unsaved){
    //         return 'This page is asking you to confirm that you want to leave - data you have entered may not be saved'
    //     }
    // }

    // window.onbeforeunload = unloadPage;
    var m = $('#job_class_type').find('option:selected').text();
    var n = '<%= @job.students.count %>'
    if (m == 'Private' || n == 1 ){
      $('#job_par_pax').val('');
      $('#job_par_pax').parents(".col-md-4").hide();
    }
    $('#job_class_type').change(function(){
      var p = $('#job_class_type').find('option:selected').text();
      if(p == "Group" && n != 1){
        $('#job_par_pax').parents(".col-md-4").show();
      }
      else if (p == 'Private'){
        $('#job_par_pax').parents(".col-md-4").hide();
        $('#job_par_pax').val('');
        $("#job_par_pax").closest('div').removeClass('has-warning');
        $('#job_par_pax').removeClass('has-warning');
      }
    });
    $("#job_edit").ajaxStart(function() {
      $("#save_job").val('Saving');
    }).ajaxComplete(function() {
      $("#save_job").val('Save');
    });

    $("#job_job_status").change(function(){
      $('#job_edit>div .has-warning').removeClass('has-warning');
      var j_status = $(this).val();
      if (j_status == 'Invoice' || j_status == "Receipt"){
         $('.form-body').find('.error').each(function(){
          $(this).removeClass('error success');
        });
        venue_id();
        class_type();
        age_group();
        day_of_week();
        class_time();
        start_date();
        fee_type();
        per_pax();
        fee_total();
        referral_type();
        instuctor();
        if ($('#job_fee_type_id option:selected').text() == 'per course'){
          completed_by();
          lesson_count();
        }
      }
      else if (j_status == "Suggest"){
        $('.form-body').find('.error').each(function(){
          $(this).removeClass('error success');
        });
        venue_id();
        class_type();
        age_group();
        per_pax();
        fee_total();
        referral_type();
        $("#job_day_of_week").closest('div').removeClass('has-success has-warning');
        $('#job_class_time').closest('div').removeClass('has-success has-warning');
        $('#job_instructor_id').closest('div').removeClass('has-success has-warning');
        $('#job_start_date').closest('div').removeClass('has-success has-warning');
        $('#job_fee_type_id').closest('div').removeClass('has-success has-warning');

      }
      else if (j_status == "Post"){
        $('.form-body').find('.error').each(function(){
          $(this).removeClass('error success');
        });
        venue_id();
        class_type();
        age_group();
        preferred_time();
        start_date();
        fee_type();
        per_pax();
        fee_total();
        referral_type();
        instuctor();

        $("#job_day_of_week").closest('div').removeClass('has-success has-warning');
        $('#job_class_time').closest('div').removeClass('has-success has-warning');
      }
      else if (j_status == "New"){
        $('.form-body').find('.error').each(function(){
          $(this).removeClass('error success');
        });
        $("#job_edit").find('.has-success').each(function(){
          $(this).removeClass('has-success')
        });
        $("#job_edit").find('.has-warning').each(function(){
          $(this).removeClass('has-warning')
        });
      }
    });

    var d_job_status = $("#job_job_status").val();
    if (d_job_status == "Invoice" || d_job_status == "Receipt"){
      venue_id();
      class_type();
      age_group();
      day_of_week();
      class_time();
      start_date();
      fee_type();
      per_pax();
      fee_total();
      referral_type();
      instuctor();
      if ($('#job_fee_type_id option:selected').text() == 'per course'){
        completed_by();
        lesson_count();
      }
    }
    else if (d_job_status == "Suggest"){
      venue_id();
      class_type();
      age_group();
      per_pax();
      fee_total();
      referral_type();
    }
    else if(d_job_status == "Post"){
      venue_id();
      class_type();
      age_group();
      preferred_time();
      start_date();
      fee_type();
      per_pax();
      fee_total();
      referral_type();
      instuctor();
    }
  });
  var job_status = $("#job_job_status").val();
  if(job_status == "New" || job_status == "Post")
  {
    $("#job_preferred_time_input").slideDown('medium');
  } else {
    $("#job_preferred_time_input").slideUp('medium');
  }
  if(job_status == "Receipt")
    $("#goggal_status_attend").slideDown('medium');
  else
    $("#goggal_status_attend").slideUp('medium');

  var job_status_on_change_val = "";
  $("#job_job_status").change(
    function(){
      job_status_on_change_val = $(this).val();
      if(job_status_on_change_val == "New" || job_status_on_change_val == "Post")
      {
        $("#job_preferred_time_input").slideDown('medium');
      } else {
        $("#job_preferred_time_input").slideUp('medium');
      }

       if(job_status_on_change_val == "Receipt" )
      {
        $("#goggal_status_attend").slideDown('medium');
      } else {
        $("#goggal_status_attend").slideUp('medium');
      }
    }
  );

  $("#viewClass").click(function(event) {
    var selectedInstructor = $("#job_instructor_id").find('option:selected').val();
    var url = "<%= manage_search_classes_instructor_wise_path %>";
    var vanue_id = $('#job_venue_id').find("option:selected").val();
    var class_type = $('#job_class_type').find('option:selected').text();
    var instructor_name_val_s = $("#job_instructor_id option:selected").text();
      console.log(vanue_id)
      console.log(class_type)
      console.log(instructor_name_val_s)
      
      if(class_type == "Private" || class_type == ""){
        var age_group = ""
      }
      else{
        var age_group = $('#job_age_group').find('option:selected').text();
      }
    $.ajax({
      url: url,
      type: 'POST',
      data: { selectedInstructor: selectedInstructor ,venue: vanue_id, age_group: age_group ,instructor: instructor_name_val_s},
    }).done(function() {
      $('#large').modal('show');
    });
  });

  var instructor_name_val = "";

  instructor_name_val = $("#job_instructor_id").find('option:selected').text();

  // For view classes enabled - disabled script
    if(instructor_name_val != "Please Select")
      $("#viewClass").removeAttr('disabled')
    else
      $("#viewClass").attr('disabled','disabled')

  var template_identifier = ["< id >", "< venue_name >", "< class_level >"  , "< age_group >", "< class_type >", "< start_date >", "< completed_by >", "< fee_type >", "< student_count >", "< list_students >", "< preferred_time >", "< class_time >", "< day_of_week >", "< per_pax >", "< fee_total >", "< referral >", "< fee_remainder >", "< lead_name >", "< lead_contact >", "< instructor_name >", "< instructor_contact >", "< lesson_count >", "< show_names >", "< lady_instructor >", "< free_goggles >", "< full_payment >", "< duration >", "< pa_link >"];

  jQuery(document).ready(function() {
    Metronic.init();
    // ComponentsPickers.init();
    $('#job_class_time').timepicker({
      minuteStep: 5,
      defaultTime: '<%= @job.class_time.strftime("%I:%M %p") if @job.class_time? %>',
    });
    var selected_option = $("#job_class_type").find('option:selected').text();
    if(selected_option == "Private")
    {
      $("#group_only").hide();
    }
    var fee_structure_type = $('#job_fee_type_id').find("option:selected").text();
    if(fee_structure_type == "Per Month" || fee_structure_type == "per month")
    {
      $("#fee_structure_wise").hide();
    }
    var venue_name = $("#job_venue_id").find("option:selected").text();
    if(venue_name != "Condo") {
      $("#other_venue_block").hide();
    }
  });

  function toLower(p_str) {
    if(p_str){

      return String(p_str).toLowerCase();
    }
    else
    {
      return "";
    }
  }

    var venue_val = "";
    var class_val = "";
    var age_val = "";
    var classtype_val = "";
    var start_date_val = "";
    var completed_by_val = "";
    var fee_structure_val = "";
    var preferred_time_val = "";
    var student_count_val = "";
    var list_students_val = "";
    var class_time_val = "";
    var day_of_week_val = "";
    var par_pax_val = "";
    var fee_total_val = "";
    var referral_val = "";
    var fee_remainder_val = "";
    var lead_name_val = "";
    var lead_contact_val = "";
    var instructor_contact_val = "";
    var lesson_count_val = "";
    var show_names_val = "";
    var lady_instructor_val = "";
    var free_goggles_val = "";
    var venue_val_id = "";
    var class_level_id = "";
    var age_group_id = "";
    var class_type_id = "";
    var fee_structure_id = "";
    var job_instructor_id = "";
    var day_of_week_val_id = "";
    var job_other_venue_val = "";
    var duration_val = "";
    var arr_variable = ["id", "student_count", "list_students", "fee_remainder", "lead_name", "lead_contact", "instructor_contact", "show_names", "lady_instructor", "free_goggles", "< full_payment >", "< pa_link >" ];
    
    var esential_arr = ["< venue_name >", "< class_type >", "< start_date >", "< fee_type >", "< class_time >", "< fee_total >", "< referral >", "< fee_remainder >", "< day_of_week >", "< instructor_name >", "< instructor_contact >", "< class_level >", "< age_group >", "< completed_by >", "< lesson_count >", "< per_pax >", "< preferred_time >", "< duration >"];

    var first_detect = true;
    var error_detect = false;
    var warning_detect = false;
    var error_fault = [];
    function getFromValues(view_pa_link)
    {
      week_days_id = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
      day_of_week_val = $("#job_day_of_week").val();
      day_of_week_val = week_days_id[day_of_week_val]

      //Javascript get for objecta
      venue_val = $("#job_venue_id option:selected").text();
      class_val = $("#job_class_level option:selected").text();
      age_val =  $("#job_age_group option:selected").text();
      classtype_val = $("#job_class_type option:selected").text();
      start_date_val = $("#job_start_date").val();
      completed_by_val = $("#job_completed_by").val();
      fee_structure_val = $("#job_fee_type_id option:selected").text();

      preferred_time_val = $("#job_preferred_time").val();
      student_count_val = '<%= @job.students.count %>';
      list_students_val = '<%= @list_students.join("") %>';

      class_time_val = $("#job_class_time").val();
      day_of_week_val = day_of_week_val
      par_pax_val = $("#job_par_pax").val();
      fee_total_val = $("#job_fee_total").val();
      referral_val = $("#job_referral").val();
      fee_remainder_val = fee_total_val - referral_val;
      day_of_week_val_id = $("#job_day_of_week").val();

      lead_name_val = '<%= @job.lead_name %>';
      lead_contact_val = '<%= @job.lead_contact %>';
      instructor_contact_val = $("#inst_number").text();
      lesson_count_val = $("#job_lesson_count").val();
     
      show_names_val = $('input:checkbox[name="job[show_names]"]').is(":checked");
      lady_instructor_val = $('input:checkbox[name="job[lady_instructor]"]').is(":checked");
      free_goggles_val = $('input:checkbox[name="job[free_goggles]"]').is(":checked");
      full_payment_val = $('input:checkbox[name="job[request_full_payment]"]').is(":checked");

      job_coordinator_notes = $("textarea#job_coordinator_notes").val();
      current_job = '<%= @job.id %>';

      job_other_venue_val = $("#job_other_venue").val()
      
      venue_val_id = $("#job_venue_id option:selected").val();
      class_level_id = $("#job_class_level option:selected").val();
      age_group_id = $("#job_age_group option:selected").val();
      class_type_id = $("#job_class_type option:selected").val();
      fee_structure_id = $("#job_fee_type_id option:selected").val();
      job_instructor_id = $("#job_instructor_id option:selected").val();
      instructor_name_val = $("#job_instructor_id option:selected").text();

      duration_val = $("#job_duration").val();

      if(view_pa_link != "not_pa")
        view_pa_link = "http://app.singaporeswimming.com"+view_pa_link;

      instructor_name_val = $.trim(instructor_name_val.substring(0, instructor_name_val.indexOf('(')));
      template_value = ['<%= @job.id %>', venue_val, class_val, age_val, classtype_val, start_date_val, completed_by_val, fee_structure_val, student_count_val, list_students_val, solidReplace(preferred_time_val, /\n/,"<br />"), class_time_val, day_of_week_val, par_pax_val, fee_total_val, referral_val, fee_remainder_val, lead_name_val, lead_contact_val, instructor_name_val, instructor_contact_val, lesson_count_val, show_names_val, lady_instructor_val, free_goggles_val, full_payment_val, duration_val, view_pa_link];
    }
  
  function ispredefinedvarfilled(p_name){
    var val = "";
    if(p_name == "id")
      val = (current_job);
    else if(p_name == "student_count")
      val = (student_count_val);
    else if(p_name == "list_students")
      val = (list_students_val);
    else if(p_name == "fee_remainder")
      val = (fee_remainder_val);
    else if(p_name == "lead_name")
      val = (lead_name_val);
    else if(p_name == "lead_contact")
      val = (lead_contact_val);

    if(Number(val) == 0)
      return true;
    if(val == null || val == undefined || val == "")
      return false;
    return true;
  }

  $("#generateInvoiceSMS").click(function(event) {
    $('html, body').animate({
      scrollTop: $('#customer_message_template').offset().top - 50
    }, 1500); 
  });

  $("#generate_sms").click(function(e){
    $('html, body').animate({
        scrollTop: $('#customer_message_template').offset().top - 50
    }, 1500);
    e.preventDefault();
    e.stopPropagation();
    getFromValues("not_pa");
    var job_status_new = $("#job_job_status").val();
    var url = "<%= manage_get_template_on_generate_sms_path %>";
    if(job_status_new == "New") {
      alert("Please save data first.")
    } else {
        var url = url;
        var job_status = $("#job_job_status").val();
        $("#customer_message_template").val(" ");
        $("#instructor_message_template").val(" ");

        $.ajax({
          url: url,
          type: 'GET',
          dataType: 'js',
          data: { current_job: current_job, job_status: job_status, venue_val: venue_val_id, class_val: class_level_id, age_val: age_group_id, classtype_val: class_type_id, start_date_val: start_date_val, completed_by_val: completed_by_val, fee_structure_val: fee_structure_id, preferred_time_val: preferred_time_val, student_count_val: student_count_val, list_students_val: list_students_val, class_time_val: class_time_val, day_of_week_val: day_of_week_val_id, par_pax_val: par_pax_val, fee_total_val: fee_total_val, referral_val: referral_val, fee_remainder_val: fee_remainder_val, lesson_count_val: lesson_count_val, show_names_val: show_names_val, lady_instructor_val: lady_instructor_val, free_goggles_val: free_goggles_val, job_coordinator_notes: job_coordinator_notes, instructor: job_instructor_id, other_venue: job_other_venue_val, request_full_payment: full_payment_val, duration: duration_val }
        })
        .done(function(data) {
        })
        .fail(function(e) {
        })
        .always(function(data) {
          //Data.response tax is the result of the customer and instructor's message. Split to get 2 data
          // arr[0] - Customer Message
          // arr[1] - Instructor Message
          var arr = (data.responseText).split("*^*");
          generateSmsPoll(arr);
          textAreaAdjust1('instructor_message_template');
          textAreaAdjust1('customer_message_template');
        });
    }
  });


  $("#job_class_type").change(function(){
    var selected_option = $(this).find('option:selected').text();
    if(selected_option == "Private")
      $("#group_only").slideUp( "medium");
    else
      $("#group_only").slideDown("medium");
  });
  $('#job_fee_type_id').change(function(e) {
    var fee_structure_type = $(this).find("option:selected").text();
    if(fee_structure_type == "Per Month" || fee_structure_type == "per month")
    {
      $("#fee_structure_wise").slideUp("medium");
    } else {
      $("#fee_structure_wise").slideDown("medium");
    }
  });
  $("#job_venue_id").change(function() {
    var venue_name = $(this).find("option:selected").text();
    if(venue_name == "Condo") {
      $("#other_venue_block").slideDown('medium');
    } else {
      $("#other_venue_block").slideUp('medium');
    }
  });

  var invoiceQty = "";
  var unitCost = "";
  var descriptionDetail = "";
  var freeGoggles = "";
  $('#create_invoice').click(function(e){
    getFromValues("not_pa");

    var f_arr = [];
    $this = $(this);
    $.ajax({
      url: '/manage/message_templates/get_invoice_note',
      type: 'get',
      beforeSend: function() {
        $this.html("Creating Invoice..");
        $this.attr("disabled", true);
      }
    })
    .done(function(data) {
      data = data.replace('[\"','');
      data = data.replace('\"]','').split("---%---");

      var invoice_note = String(data[0])
      var view_pa = String(data[1])
      
      invoice_note = noteValidation(invoice_note)

      if(invoice_note == null || invoice_note == undefined || invoice_note == ""){
        $("#create_invoice").html("Create Invoice");
      }
      for(var i=0; i<template_identifier.length; i++)
      {
        view_pa = solidReplace(view_pa, template_identifier[i], template_value[i]);
      }
      invoice_note = templateDecoder(invoice_note)
      view_pa = templateDecoder(view_pa);

      var api = "<%= @api_setting.fb_api_url %>";
      e.preventDefault();
      var job_id = "<%= @job.id %>"
      
      var isPrivateJob = checkIsPrivateJob();
      if(isPrivateJob == true) {    
        invoiceQty = getQtyForInvoice();
        unitCost = getUnitCost();
        descriptionInvoice = getDescriptionInvoice();
        freeKit = freeStarterKit();
      }
      else {
        $this.html("Create Invoice");
        return false;
      }
      var classTp = $("#job_class_type option:selected").text();
      var ageGp = $("#job_age_group option:selected").text();
      
      titleInvoice = classTp

      $.ajax({
        url: '/manage/create_invoice/'+job_id,
        type: 'GET',
        data: { invoice_info_body: invoice_note, view_pa: view_pa, qty: invoiceQty, unit_cost: unitCost, description_invoice: descriptionInvoice, title_invoice: titleInvoice, free_starter_kit: freeKit },
        beforeSend: function() {
          $this.html("Creating Invoice..");
        }
      })
      .done(function(data) {
        console.log(data)
        var time = data[5]
        var url = 'https://'+api+'/updateInvoice?invoiceid='+data[1]
        var jobId = '<%= @job.id %>';
        var url_link = '\''+"/jobs/"+jobId+"/"+data[3]+'\'';
        var api = "<%= @api_setting.fb_api_url %>";
        var current_inv = '<div class="table-responsive"><table class="table table-bordered"><thead><tr><th colspan="2"><a href="https://'+api+'/invoices/'+data[1]+'" target="_blank">Invoice' +data[2]+'</a><a data-toggle="modal" id="basicModalOpen" href="#basic" data-invoice_id="' + data[1] + '" data-invoice_number="' + data[2] + '" class="delete_invoice btn red btn-xs pull-right" style="margin-left: 4px;">Delete</a></th></tr></thead><tbody id="fb_invoices"><tr><td id="invoice-timer" class="invoice-timer"><input type="hidden" name="invoice-time" value="'+data[5]+'" id="invoice-time" class="invoice-time"></td><td><a class=" btn btn-primary" data-remote="true" href="/manage/reset_invoice_time_popup/'+ data[0]+'">Edit</a></td>    </tr><tr><td>Status</td><td>Draft  <span class="glyphicon glyphicon-warning-sign" aria-hidden="true" style="color: red;"></span></td></tr><tr><td>Total</td><td>$'+data[4]+'</td></tr><tr><td>Paid</td><td>$ 0.00</td></tr><tr><td colspan="2"><a id="generateInvoiceSMS" href="javascript:;" onclick="generateInvoiceSms(' + url_link + ');" data-invoice_id="' + data[1] + '" data-invoice_number="' + data[2] + '" class="delete_invoice btn blue btn-sm"> Generate SMS</a><div class="btn-group"><a href="/jobs/<%= @job.id %>/' + data[3] + '" id="sms_payment" target="_blank" class="btn default btn-xs" >View PA</a></div></td></tr></tbody></table></div>';

        if($("#fb_invoices").is(":visible") == true) {
          $('.generate_new_invoice').append(current_inv);
        }
        else {
          $("#after_create_inv_p").attr('href', url);
          $("#after_create_inv_p").text(data[1]);
          // $("#fb_invoices_tbl").show();
          // $("#fb_invoices_tbl").append('<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Invoice #</th><th>Status</th><th>Total</th><th>Paid</th><th></th></tr></thead><tbody id="fb_invoices">'+current_inv+'</tbody></table></div>').delay(5000).queue(function() {
          //   $("#fb_invoices").find('.success').removeClass('success');
          //   $("#fb_invoices").dequeue();
          // });
          invoiceQty = "";
          unitCost = "";
          descriptionDetail = "";
          freeGoggles = "";
          $('.generate_new_invoice').append(current_inv);
          $('html,body').animate({
            scrollTop: $(".generate_new_invoice").offset().top - 50
          },500);
        }
        $this.html("Create Invoice");
          var invoice = data[5];
          console.log("invoice" + invoice)
          l = invoice *1
          if (l > 0 && l > 60){
            var minute = invoice/60
            var hours = minute/60
            var hh = Math.floor(hours);
            var mm = Math.floor(minute - hh*60)
            $('.invoice-timer').html(hh+'h '+mm+ 'm left');
            console.log(hh);
            console.log(mm);
            intl = setInterval(function(){
              var isOver = false;
              mm --;
              if(mm < 0 ){
                hh--;
                mm = 59
                if (hh < 0){
                  clearInterval(intl);
                  $('.invoice-timer').html('Expired');
                  isOver = true;
                }
              }
              if (isOver== false){ 
                $('.invoice-timer').html(hh+'h '+mm+ 'm left');
              }
            },60000);
          }else{
            $('.invoice-timer').html('Expired');
          }
      })
      .fail(function(data) {
        if(data.responseText.length > 0) {
          data = data.responseText.replace(/[\[\]']+/g,'').split(",")
          if(data[1] == undefined)
            data[1] = 503
          $modal = $('.invoice_err'),
          $modalBody = $('.modal-title'),
          $modalBody.html('Error : ' + data[0] + '<br>' + 'Error Code : ' + data[1]);
          $modal.modal();
          $this.html("Create Invoice");
        }
        else {
          $modal = $('.invoice_err'),
          $modal.modal();
          $this.html("Create Invoice");
        }
      })
    });
  });

var intl;
// invoice timer  countdown 24 hours
$( document ).ready(function() {
  var invoice = $('#invoice_time').val();

  l = invoice *1
  if (l > 0 && l > 60){
    console.log(invoice * 1)
    var minute = invoice/60
    var hours = minute/60
    var hh = Math.floor(hours);
    var mm = Math.floor(minute - hh*60)
    $('.invoice-timer').html(hh+'h '+mm+ 'm left');
    intl = setInterval(function(){
      var isOver = false;
      mm --;
      if(mm < 0 ){
        hh--;
        mm = 59
        if (hh < 0){
          clearInterval(intl);
          $('.invoice-timer').html('Expired');
          isOver = true;
        }
      }
      if (isOver== false){
        $('.invoice-timer').html( hh+'h '+mm+ 'm left');
      }
    },60000);
  }else{
    $('.invoice-timer').html('Expired');
  }

  // intl
  // $('.invoice-timer').countdown(invoice, function(event) {
  //   $(this).html(event.strftime('%Hh %Mm left'));
  // });

});

  $('.update_invoice').click(function(e){
    getFromValues("not_pa");
    var f_arr = [];
    $this = $(this);
    $.ajax({
      url: '/manage/message_templates/get_invoice_note',
      type: 'get',
      beforeSend: function() {
        $this.html("Updating Invoice..");
      }
    })
    .done(function(data) {
      data = data.replace('[\"','');
      data = data.replace('\"]','').split("---%---");

      var invoice_note = String(data[0])
      var view_pa = String(data[1])

      invoice_note = noteValidation(invoice_note)

      if(invoice_note == null || invoice_note == undefined || invoice_note == ""){
        $("#create_invoice").html("Update Invoice");
      }
      for(var i=0; i<template_identifier.length; i++)
      {
        view_pa = solidReplace(view_pa, template_identifier[i], template_value[i]);
      }
      invoice_note = templateDecoder(invoice_note)
      view_pa = templateDecoder(view_pa);

      var api = "<%= @api_setting.fb_api_url %>";
      e.preventDefault();
      var job_id = "<%= @job.id %>"
      
      var isPrivateJob = checkIsPrivateJob();
      if(isPrivateJob == true) {    
        invoiceQty = getQtyForInvoice();
        unitCost = getUnitCost();
        descriptionInvoice = getDescriptionInvoice();
        freeKit = freeStarterKit();
      }
      else {
        $this.html("Update");
        return false;
      }
      var classTp = $("#job_class_type option:selected").text();
      var ageGp = $("#job_age_group option:selected").text();
      titleInvoice = classTp
      $.ajax({
        url: $this.data('href'),
        type: 'GET',
        data: { invoice_info_body: invoice_note, view_pa: view_pa, qty: invoiceQty, unit_cost: unitCost, description_invoice: descriptionInvoice, title_invoice: titleInvoice, free_starter_kit: freeKit },
        beforeSend: function() {
          $this.html("Updating Invoice..");
        }
      })
      .done(function(data) {
        $modal = $('.invoice_err'),
        $modalBody = $('.modal-title'),
        $modalBody.html('Invoice Updated successfully');
        $modal.modal();
        $(".modal-footer").hide();
        $this.html("Update");
      })
      .fail(function(data) {
        if(data.responseText.length > 0) {
          data = data.responseText.replace(/[\[\]']+/g,'').split(",")
          if(data[1] == undefined)
            data[1] = 503
          $modal = $('.invoice_err'),
          $modalBody = $('.modal-title'),
          $modalBody.html('Error : ' + data[0] + '<br>' + 'Error Code : ' + data[1]);
          $modal.modal();
          $this.html("Update");
        }
        else {
          $modal = $('.invoice_err'),
          $modal.modal();
          $this.html("Update");
        }
      })
    });
  });


  $("#job_venue_id").change(function(){
    var job_status = $('#job_job_status option:selected').value;
    var venue = $("#job_venue_id").val();
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(venue == "")
      {
        $("#job_venue_id").closest('div').removeClass('has-success');
        $("#job_venue_id").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_venue_id").closest('div').removeClass('has-warning');
        $("#job_venue_id").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_age_group").change(function(){
    var job_status = $('#job_job_status option:selected').value;

    var age_group = $("#job_age_group").val();
    
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(age_group == "")
      {
        $("#job_age_group").closest('div').removeClass('has-success');
        $("#job_age_group").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_age_group").closest('div').removeClass('has-warning');
        $("#job_age_group").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_class_type").change(function(){
    var job_status = $('#job_job_status option:selected').value;
   var class_type = $("#job_class_type").val();
    
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(class_type == "")
      {
        $("#job_class_type").closest('div').removeClass('has-success');
        $("#job_class_type").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_class_type").closest('div').removeClass('has-warning');
        $("#job_class_type").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_preferred_time").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
   var preferred_time = $("#job_preferred_time").val();
    
    if(job_status == "Post")
    {
      if(preferred_time == "")
      {
        $("#job_preferred_time").closest('div').removeClass('has-success');
        $("#job_preferred_time").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_preferred_time").closest('div').removeClass('has-warning');
        $("#job_preferred_time").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_fee_type_id").change(function(){
    var job_status = $('#job_job_status option:selected').value;
   var fee_type = $("#job_fee_type_id").val();
    
    if(job_status == "Post" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(fee_type == "")
      {
        $("#job_fee_type_id").closest('div').removeClass('has-success');
        $("#job_fee_type_id").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_fee_type_id").closest('div').removeClass('has-warning');
        $("#job_fee_type_id").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_start_date").change(function(){
    var job_status = $('#job_job_status option:selected').value;
   var start_date = $("#job_start_date").val();
    
    if(job_status == "Post" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(start_date == "")
      {
        $("#job_start_date").closest('div').removeClass('has-success');
        $("#job_start_date").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_start_date").closest('div').removeClass('has-warning');
        $("#job_start_date").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_referral").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
   var job_referral = $("#job_referral").val();
    
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(job_referral == "")
      {
        $("#job_referral").closest('div').removeClass('has-success');
        $("#job_referral").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_referral").closest('div').removeClass('has-warning');
        $("#job_referral").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_fee_total").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
   var fee_total = $("#job_fee_total").val();
    
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(fee_total == "")
      {
        $("#job_fee_total").closest('div').removeClass('has-success');
        $("#job_fee_total").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_fee_total").closest('div').removeClass('has-warning');
        $("#job_fee_total").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_par_pax").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
    var per_pax = $("#job_par_pax").val();
    
    if(job_status == "Post" || job_status == "Suggest" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(per_pax == "")
      {
        $("#job_par_pax").closest('div').removeClass('has-success');
        $("#job_par_pax").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_par_pax").closest('div').removeClass('has-warning');
        $("#job_par_pax").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_instructor_id").change(function(){
    var job_status = $('#job_job_status option:selected').value;
    var job_instructor_id = $("#job_instructor_id").val();
    
    if(job_status == "Post" || job_status == "Invoice" || job_status == "Receipt")
    {
      if(job_instructor_id == "")
      {
        $("#job_instructor_id").closest('div').removeClass('has-success');
        $("#job_instructor_id").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_instructor_id").closest('div').removeClass('has-warning');
        $("#job_instructor_id").closest('div').addClass('has-success');
      }  
    }
    var instructor_name_val_s = $("#job_instructor_id option:selected").text();

    if(instructor_name_val_s != "Please Select")
      $("#viewClass").removeAttr('disabled')
    else
      $("#viewClass").attr('disabled','disabled')

    instructor_name_val_s = $.trim(instructor_name_val_s.substring(0, instructor_name_val_s.indexOf('-')));
    $.ajax({
      url: '/manage/get_instructor?short_nm=true',
      type: 'get',
      data: { instructor: instructor_name_val_s },
     })
     .done(function(data) {
        $("#job_instructor_id option:selected").attr({"data-shortname":data});
     });
      
  });
  $("#job_day_of_week").change(function(){
    var job_status = $('#job_job_status option:selected').value;
    var day_of_week = $("#job_day_of_week").val();
    
    if(job_status == "Invoice" || job_status == "Receipt")
    {
      if(day_of_week == "")
      {
        $("#job_day_of_week").closest('div').removeClass('has-success');
        $("#job_day_of_week").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_day_of_week").closest('div').removeClass('has-warning');
        $("#job_day_of_week").closest('div').addClass('has-success');
      }  
    } 
  });
  $("#job_class_time").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
    var class_time = $("#job_class_time").val();
    
    if(job_status == "Invoice" || job_status == "Receipt")
    {
      if(class_time == "")
      {
        $("#job_class_time").closest('div').removeClass('has-success');
        $("#job_class_time").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_class_time").closest('div').removeClass('has-warning');
        $("#job_class_time").closest('div').addClass('has-success');
      }  
      
    } 
  });
  
  $("#job_completed_by").blur(function(){
    var job_status = $('#job_job_status option:selected').value;
    var completed_by = $("#job_completed_by").val();
    if(job_status == "Invoice" || job_status == "Receipt")
    {
      // console.log(completed_by)
      if(completed_by == "")
      {
        $("#job_completed_by").closest('div').removeClass('has-success');
        $("#job_completed_by").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_completed_by").closest('div').removeClass('has-warning');
        $("#job_completed_by").closest('div').addClass('has-success');
      }  
      
    } 
  });
  $("#job_lesson_count").blur(function(event){
    var job_status = $('#job_job_status option:selected').value;
    var lesson_count = $("#job_lesson_count").val();
    
    if(job_status == "Invoice" || job_status == "Receipt")
    {
      if(lesson_count == "")
      {
        $("#job_lesson_count").closest('div').removeClass('has-success');
        $("#job_lesson_count").closest('div').addClass('has-warning');
      }
      else
      {
        $("#job_lesson_count").closest('div').removeClass('has-warning');
        $("#job_lesson_count").closest('div').addClass('has-success');
      }  
    } 
  });
  
  
  // $("#as").html(str + "<br><br>" + templateDecoder(str) + "<br><br>"+ extrastr);
  //--------------------------------------------------------
  
  var month_arr = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]

  // Count total weeks between start_date and completed_date
  $("#count_lesson").click(function(){
    var start_date_val = $("#job_start_date").val();
    var arr = start_date_val.split(" ")
    if(isNaN($("#job_lesson_count").val()) == true || $("#job_lesson_count").val() == "")
      {
        $("#job_lesson_count").val("")
        return;
      }
    var job_lesson_count = $("#job_lesson_count").val() - 1;
    var count_days_from_week = job_lesson_count * 7; 
    for(var i=0; i < month_arr.length;i++)
    {
      if(month_arr[i] == arr[1])
      {
        arr[1] = i + 1;
        break;
      }
    }
    
    dt = new Date(arr[2], parseInt( arr[1], 10 ) - 1, arr[0]), // months are 0 based, so need to add 1
    inFourWeeks = new Date( dt.getTime() + count_days_from_week * 24 * 60 * 60 * 1000 );

    $(function(){
      $('#job_completed_by').val( inFourWeeks.getDate() + " " + month_arr[inFourWeeks.getMonth()] + " " + inFourWeeks.getFullYear());
      $("#job_completed_by").datepicker( "setDate", inFourWeeks.getDate() + " " + month_arr[inFourWeeks.getMonth()] + " " + inFourWeeks.getFullYear());
    });
  });

  // Bootstrap Datepickers
  $(document).ready(function () {
    var days = [0,1,2,3,4,5,6];
    var enableDay = $('#job_day_of_week').val();
    var index = days.indexOf(parseInt(enableDay));
    days.splice(index, 1);

    $(document).on('change', '#job_day_of_week', function(event) {
      $('#job_start_date').val('');
      $('#job_start_date').datepicker('remove');

      days = [0,1,2,3,4,5,6]
      enableDay = $('#job_day_of_week').val();
      index = days.indexOf(parseInt(enableDay));
      days.splice(index, 1);

        $('#job_start_date').datepicker({
          format: 'd MM yyyy',
          todayHighlight: true,
          daysOfWeekDisabled: days
        });
    });

    $('#job_start_date').datepicker({
        format: 'd MM yyyy',
          todayHighlight: true,
        daysOfWeekDisabled: days
    });  
    $('#job_completed_by').datepicker({
      format: 'd MM yyyy'
    });
    $('#search_group').click(function(){
      var vanue_id = $('#job_venue_id').find("option:selected").val();
      var class_type = $('#job_class_type').find('option:selected').text();
      if(class_type == "Private" || class_type == ""){
        var age_group = ""
      }
      else{
        var age_group = $('#job_age_group').find('option:selected').text();
      }
      $.ajax({
        url: '<%= manage_group_search_path %>',
        type: 'GET',
        data: {venue: vanue_id, age_group: age_group},
      })
      .done(function() {
        $('#large').modal('show');
      })
      .fail(function() {
        console.log("error");
      })
      .always(function() {
        console.log("complete");
      });
      
    });  
  });

  $('#job_job_status').change(function() {
    if($(this).val() == "Delete"){
      $('label:has(input:radio:checked)').addClass('red');
      $('label:has(input:radio:not(:checked))').removeClass('blue-madison').addClass('btn-default');
    } else {
      $('label:has(input:radio:checked)').addClass('blue-madison');
      $('label:has(input:radio:not(:checked))').removeClass('blue-madison').removeClass('red').addClass('btn-default');
    }
  });
  function venue_id(){
    var d_venue = $('#job_venue_id  option:selected').text();
    if (d_venue == ''){
      $("#job_venue_id").closest('div').removeClass('has-success');
      $("#job_venue_id").closest('div').addClass('has-warning');
    }
    else {
      $("#job_venue_id").closest('div').removeClass('has-warning');
      $("#job_venue_id").closest('div').addClass('has-success');
    }
  }
  function preferred_time(){
    var d_preferred_time = $('#job_preferred_time').val();
    if(d_preferred_time == ''){
      $("#job_preferred_time").closest('div').removeClass('has-success');
      $("#job_preferred_time").closest('div').addClass('has-warning');
    }
    else{
      $("#job_preferred_time").closest('div').removeClass('has-warning');
      $("#job_preferred_time").closest('div').addClass('has-success');
    }
  }
  function class_type(){
    var d_class_type = $('#job_class_type option:selected').text();
    if (d_class_type == ''){
      $("#job_class_type").closest('div').removeClass('has-success');
      $("#job_class_type").closest('div').addClass('has-warning');
    }
    else{
      $("#job_class_type").closest('div').removeClass('has-warning');
      $("#job_class_type").closest('div').addClass('has-success');
    }
  }
  function age_group(){
    var d_age_group = $('#job_age_group option:selected').text();
    if (d_age_group == ''){
      $("#job_age_group").closest('div').removeClass('has-success');
      $("#job_age_group").closest('div').addClass('has-warning'); 
    }
    else{
      $("#job_age_group").closest('div').removeClass('has-warning');
      $("#job_age_group").closest('div').addClass('has-success'); 
    }
  }
  function day_of_week(){
    var d_day_of_week = $("#job_day_of_week").val();
    if (d_day_of_week == ''){
      $("#job_day_of_week").closest('div').removeClass('has-success');
      $("#job_day_of_week").closest('div').addClass('has-warning');
    }
    else{
      $("#job_day_of_week").closest('div').removeClass('has-warning');
      $("#job_day_of_week").closest('div').addClass('has-success');
    }
  }
  function start_date(){
    var d_start_date = $('#job_start_date').val();
    if (d_start_date == ''){
      $("#job_start_date").closest('div').removeClass('has-success');
      $("#job_start_date").closest('div').addClass('has-warning');
      $('#job_start_date').closest('div').find('label').css("color: #c09853;")
    }
    else{
      $("#job_start_date").closest('div').removeClass('has-warning');
      $("#job_start_date").closest('div').addClass('has-success');
    }
  }
  function fee_type(){
    var d_fee_type = $('#job_fee_type_id option:selected').text();
    if (d_fee_type == ''){
      $("#job_fee_type_id").closest('div').removeClass('has-success');
      $("#job_fee_type_id").closest('div').addClass('has-warning');
    }
    else{
      $("#job_fee_type_id").closest('div').removeClass('has-warning');
      $("#job_fee_type_id").closest('div').addClass('has-success');
    }
  }
  function per_pax(){
    var d_par_pax = $('#job_par_pax').val();
    if (d_par_pax == ''){
      $("#job_par_pax").closest('div').removeClass('has-success');
      $("#job_par_pax").closest('div').addClass('has-warning');
    }
    else{
      $("#job_par_pax").closest('div').removeClass('has-warning');
      $("#job_par_pax").closest('div').addClass('has-success');
    }
  }
  function fee_total(){
    var d_fee_total = $('#job_fee_total').val();
    if (d_fee_total == ''){
      $("#job_fee_total").closest('div').removeClass('has-success');
      $("#job_fee_total").closest('div').addClass('has-warning');
    }
    else{
      $("#job_fee_total").closest('div').removeClass('has-warning');
      $("#job_fee_total").closest('div').addClass('has-success');
    }
  }
  function referral_type(){
    var d_refferal = $('#job_referral').val();
    if (d_refferal == ''){
      $("#job_referral").closest('div').removeClass('has-success');
      $("#job_referral").closest('div').addClass('has-warning');
    }
    else{
      $("#job_referral").closest('div').removeClass('has-warning');
      $("#job_referral").closest('div').addClass('has-success');
    }
  }
  function instuctor(){
    var d_instructor = $('#job_instructor_id option:selected').text();
    if (d_instructor == ''){
      $("#job_instructor_id").closest('div').removeClass('has-success');
      $("#job_instructor_id").closest('div').addClass('has-warning');
    }
    else{
      $("#job_instructor_id").closest('div').removeClass('has-warning');
      $("#job_instructor_id").closest('div').addClass('has-success');
    }
  }
  function class_time(){
    setTimeout(function(){ 
      var d_class_time = $('#job_class_time').val();
      if (d_class_time == ''){
        $("#job_class_time").closest('div').removeClass('has-success');
        $("#job_class_time").closest('div').addClass('has-warning');
      }
      else{
        $("#job_class_time").closest('div').removeClass('has-warning');
        $("#job_class_time").closest('div').addClass('has-success');
      }
    }, 200);
  }
  function completed_by(){
    var d_completed_by = $('#job_completed_by').val();
    if (d_completed_by == ''){
      $("#job_completed_by").closest('div').removeClass('has-success');
      $("#job_completed_by").closest('div').addClass('has-warning');
    }
    else{
      $("#job_completed_by").closest('div').removeClass('has-warning');
      $("#job_completed_by").closest('div').addClass('has-success');
    }
  }
  function lesson_count(){
    var d_lesson_count = $('#job_lesson_count').val();
    if (d_lesson_count == ''){
      $("#job_lesson_count").closest('div').removeClass('has-success');
      $("#job_lesson_count").closest('div').addClass('has-warning');
    }
    else{
      $("#job_lesson_count").closest('div').removeClass('has-warning');
      $("#job_lesson_count").closest('div').addClass('has-success');
    }
  }
  $(document).ready(function($) {
    setTimeout(function(){
      $(".alert-success").fadeOut('slow', function() {
      });
    },3000);
    $('#job_completed_by').change(function(){
      $('.datepicker').css("display","none");
    });
    $('#job_start_date').change(function(){
      $('.datepicker').css("display","none");
    });
  });

  /* Activating Best In Place */
  $(document).ready(function() {
    jQuery(".best_in_place").best_in_place();
  });

  //For in-line editing of referral and balance
  
</script>



<style type="text/css">
  .today{
    background-color: #bfcad1;
  }
  input[name="job[fee_structure]"]{
    margin-left: 0 !important;
  }
  .datepicker .datepicker-dropdown .dropdown-menu .datepicker-orient-left .datepicker-orient-bottom {
    width: 230px !important;
  }
  .datepicker.datepicker-dropdown.dropdown-menu{
    min-width: 240px !important;
  }
  .replace_str { white-space: pre-wrap; }
  .chats li.out .message { text-align: left !important; }
  .error{
    border-color: #f00 !important;
  }
  .success{
    border-color: #356635;
  }

  .replace_str {
    word-wrap: break-word;
  }
  #lead_email {
    word-break: break-all;
  }
  /*#job_preferred_time { white-space:pre; }*/
 #viewClass { margin-top: 25px; }
</style>
<div class="modal fade bs-modal-lg" id="large" tabindex="-1" role="dialog" aria-hidden="true">
</div>
<div class="modal inv_det_modal fade bs-modal-sm" id="large" tabindex="-1" role="dialog" aria-hidden="true" >
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title" style="border-bottom: none !important;">
          Click here to view invoice detail <a href='' id="after_create_inv_p" target="_blank"></a>
        </h4>
      </div>
      <div class="modal-footer" style="border-top: none;">
        <button type="button" class="btn default" data-dismiss="modal" onClick="window.location.reload();">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="view_classes" tabindex="-1" role="basic" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">Modal Title</h4>
      </div>
      <div class="modal-body">
        Modal body goes here
      </div>
      <div class="modal-footer">
        <button type="button" class="btn default" data-dismiss="modal">Close</button>
        <button type="button" class="btn blue">Save changes</button>
      </div>
    </div>
  </div>
</div>



<div class="modal invoice_err fade bs-modal-sm" id="small" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title" style="border-bottom: none !important;">Email Can't be blank</h4>
      </div>
      <div class="modal-footer" style="border-top: none !important;">
        <button type="button" class="btn default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deletePayment" tabindex="-1"  aria-hidden="true">                                    
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">Delete not allowed</h4>
      </div>
      <div class="modal-body">
         Cannot delete invoice because payment has been added. 
      </div>
      <div class="modal-footer" style="text-align: center !important;">
        <button type="button" class="btn default" data-dismiss="modal">Okay</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>


<script type="text/javascript">
  
   $(document).ready(function() {
      $('.manual_payment').click(function(){
        $(this).text("Commiting..");
      });
    // $("a").click(function() {
    //  link_host = this.href.split("/")[2];
    //  document_host = document.location.href.split("/")[2];

    //  if (link_host != document_host) {
    //    // window.open(this.href);
    //    return false;
    //   }
    // });
    $('#printPdf').click(function(){
      $('#print').modal('hide');
    });
    $('.terms_and_condition').click(function(){
      if($(this).is(':checked')){
        var t_id = $(this).attr("id");
        $('.terms_and_condition').each(function(){
          if ($(this).attr("id") != t_id){
            $(this).prop("checked", false);
            $(this).parents('span').removeClass("checked");
          }
        });
      }
    });
  });

  function ClickHereToPrint(){
    var content = "Hello";
    var name = $('#print_name').val();
    var address = $('#print_address').val();
    var quantity = $('#print_quantity').val();
    var prtContent = '<div style="width: 248px; height: 108px; padding-left: 8px; padding-right: 8px; margin-top: 10px; margin-bottom: 10px; float: left;"><div style="font-family: arial; font-size: 32px; margin-bottom: 10px;"><center>Singapore<strong>Swimming</strong>Academy</center></div><div style="font-weight: bold; font-family: arial; font-size: 24px; margin-bottom: 5px;">'+name+'</div><div style="font-family: arial; font-size: 22px;"><pre>'+address+'</pre></div><div style="float: right; margin-top: 0px;">'+quantity+'</div></div>'
    var WinPrint = window.open('', '','toolbar=0,scrollbars=0,status=0');
    WinPrint.document.write(prtContent);
    WinPrint.document.close();
    WinPrint.focus();
    WinPrint.print();
    WinPrint.close();
  }
  function autoFillPdfData(){
    var classDetail = $('#job_day_of_week option:selected').text().substring(0,3);
    var startDate = $('#job_start_date').val().split(' ');
    var date = ""
    var month = ""
    var year = ""

    var newStartDetail = ""
    var startdetail = "\n"

    var newClassDetail = "\n"
    var newStartDetail = "\n"
    var venuName = "\n"
    var instructorName = "\n"

    if(startDate != ""){
      if (startDate[0] == ""){
        date = startDate[1];
        month = startDate[2].substring(0,3);
        year = startDate[3]
      }
      else
      { 
        date = startDate[0];
        month = startDate[1].substring(0,3);
        year = startDate[2]
      }
    }
    

    if($("#job_instructor_id option:selected").text().length > 0)
      instructorName = "Coach: "+ $("#job_instructor_id option:selected").text().split('(')[0]+"\n";
    var dayTime = $('#job_class_time').val();
    
    if(dayTime.indexOf(':00') != -1)
    {
      dayTime = dayTime.replace(":00", "");
    }
    newClassDetail = classDetail + " " + dayTime.toLowerCase() ;
    if(startDate != "")
      newStartDetail = " (Start: "+date+" "+month+ ")\n"
    if($('#job_venue_id').find("option:selected").text().length > 0)
      venuName = $('#job_venue_id').find("option:selected").text()+"\n";

    var autoFillDataFinal = newClassDetail + newStartDetail + venuName + instructorName
    
    $('#print_address').val(autoFillDataFinal);

    // manage_gorup_classes_by_venue_path
  }
  $(document).on('change', '.venue', function(event) {
    $('.gc_by_venue').show();
    $.ajax({
      url: '/manage/gorup_classes_by_venue',
      dataType: 'script',
      data: {age_group: $('.age_group').val(),venue: $(this).val(),job_id: $('#job_h_id').val()},
    })    
  });
  $(document).on('change', '.inst-list', function(event) {
    $.ajax({
      url: '/manage/gorup_classes_by_venue',
      dataType: 'script',
      data: {age_group: $('.age_group').val(),instructor: $(this).val(),venue: $(".venue").val(),job_id: $('#job_h_id').val()},
    })    
  });
  $(document).on('change', '.age_group', function(event) {
    $('.gc_by_venue').show();
    $.ajax({
      url: '/manage/gorup_classes_by_venue',
      dataType: 'script',
      data: {age_group: $(this).val(),instructor: $('.inst-list').val(),venue: $(".venue").val(),job_id: $('#job_h_id').val()},
    })    
  });
  $(document).on('click', '.btn-gc', function(event) {
    $('.spin').show();
  });
  $(document).on('click', '.btn-avail', function(event) {
    $('#gc-' + $(this).attr('id')).html("<img src='/assets/input-spinner.gif' alt='loading' class='spin'>")
  });
  // $(document).on('click', '.inst_name', function(event) {
  //   $.ajax({
  //     url: '/manage/gorup_classes_by_venue',
  //     dataType: 'script',
  //     data: {age_group: $('.age_group').val(),instructor: $(this).val(),venue: $(".venue").val(),job_id: $('#job_h_id').val()},
  //   })
  // });
  $(document).on('click', '.inst_name', function(event) {
    if($(".inst-list").length > 0){
      $(".inst-list").val($(this).attr('data-value')).trigger('change');
    }
  }); 
</script><style type="text/css">
  .add_balance{
    padding-bottom: 10px;
    margin-top: -12px;
    margin-left: -25px;
  }
  .btn-gc{
  margin-top: 10px;
  width: 98px;
}
.btn-avail{
  margin-top: 10px;
}
</style>