<% title @instructor_student.student_name %>
  <% @student_award_registered.each do |student_award_register| %>
    <% if !student_award_register.award.blank? %>
        <% student_award_register.award.award_tests.each do |award_test| %>
          <% if (award_test.id == student_award_register.award_test_id && student_award_register.status != "Fail") %>

            <div class="alert alert-success col-xs-12" style="position: relative; padding-right: 15px; padding-left: 15px; margin-right: auto; margin-left: auto;">
              <%= student_award_register.award.name %><br>
              <%= Venue.find_by_id(award_test.venue_id).name unless award_test.venue_id.blank? %><br>
              <%= award_test.test_date.strftime("%e %b %Y") + " - " + award_test.test_time.strftime("%I:%M %p") %><br>

              <%# if student_award_register.status == "Pending"%>
                <!-- <strong>Please pass the test fee of $<%#= format('%.2f', award_test.test_fee) if award_test.test_fee.present? %> to <%#= award_test.assessor.present? ? AdminUser.find(award_test.assessor).name : "your instructor" %> to confirm registration.</strong> -->
                <%#= award_test.award.inspect %>
              <%# elsif student_award_register.status == "Confirmed" %>
              <% if AwardTestPaymentNotification.check_paid_or_not(award_test.id,@instructor_student.id) %>
                <strong>Please report <%= award_test.assessor.present? ? AdminUser.find(award_test.assessor).name + '(' + AdminUser.find(award_test.assessor).mobile + ')' : ""  %> at the deep pool 10 mins earlier.</strong>
              <%# end %>
              <% else %>
                <strong>Please pass the test fee of $<%= format('%.2f', award_test.test_fee) if award_test.test_fee.present? %> to <%= award_test.assessor.present? ? AdminUser.find(award_test.assessor).name : "your instructor" %>.</strong>
              <%# if student_award_register.status != "Confirmed" %>
                <% if award_test.cut_off_date.present? %>
                  <% if  Date.today <= award_test.cut_off_date %>
                    <a href="<%= student_cancel_booking_path(student_award_register) %>" class="btn red pull-right btn-xs" style="float: right;">Cancel Booking</a>
                  <% end %>
                <% end %> 
              <% end %>                       
            </div>
          <% end %>
        <% end %>
    <% end %>
  <% end %>
<div class="container col-xs-12 col-sm-6 col-md-6 col-lg-4">
  <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20">
  <div class="row ">
      <div class="col-xs-4 studentProfilePic ">
        <% if @instructor_student.profile_picture? %>
           <%= image_tag(@instructor_student.profile_picture(:medium),:class => "img-responsive")%>
        <% else %>
          <img src="/assets/no_image.gif" alt="", class="img-responsive "/>
        <% end %>
         <div id="fine-uploader"></div>
      </div>
      <div class="col-xs-8">
        <h2><%= @instructor_student.student_name %></h2>
      </div> 
    <div class="col-xs-12"><h4>Class Details</h4></div>
    <% @instructor_student.group_classes.each do |group_classes| %>
      <div class="row">
        <div class="col-xs-4 text-right text-muted">Class</div>
        <div class="col-xs-8"><%= @day_array[group_classes.day] +' '+ group_classes.time.strftime("%l:%M %P")%></div>
      </div>
      <div class="row">
        <div class="col-xs-4 text-right text-muted">Instructor</div>
        <div class="col-xs-8"><%= group_classes.instructor.name %></div>
      </div>   
    <% end %>
  </div>
  <hr>
  <div class="row">
    <div class="col-xs-6">
      <h2>Basic Info</h2>
    </div>
    <div class="col-xs-6 text-right">
      <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="btn btn-sm default ">Update Basic Info</a>
    </div>
  </div>
  <div class="margin-bottom-10  ">
    <div class="text-left small alert alert-danger  error-register" style="display: none; padding-right: 0px;">
      <strong>Please update all particulars</strong><br>Fill up all student particulars to book for test
    </div>
  </div>
  <!-- <div class="col-xs-12"><h4>Student particulars</h4></div> -->
  <div class="row">
    <div class="col-xs-4 text-right text-muted">Full Name</div>
    <div class="col-xs-8 text-warning">
      <% if !@instructor_student.student_name.blank? %>
        <%= @instructor_student.student_name %>
      <% else %>
        <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="text-warning"><i class="fa fa-warning"></i> Please update  </a>
      <% end %>  
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4 text-right text-muted">IC number</div>
    <div class="col-xs-8 text-warning">
      <% if !@instructor_student.ic_number.blank? %>
        <%= @instructor_student.ic_number %>
      <% else %>
        <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="text-warning"><i class="fa fa-warning"></i> Please update  </a>
      <% end %>  
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4 text-right text-muted">Gender</div>
    <div class="col-xs-8 text-warning">
      <% if !@instructor_student.gender.blank? %>
        <% if @instructor_student.gender.downcase == "f" || @instructor_student.gender.downcase == "female" %>
          Female
        <% else %>
          Male
        <% end %>
      <% else %>
        <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="text-warning"><i class="fa fa-warning"></i> Please update  </a>
      <% end %>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4 text-right text-muted">D.O.B</div>
    <div class="col-xs-8 text-warning">
      <% if !@instructor_student.date_of_birth.blank?  %>
        <%= @instructor_student.date_of_birth.strftime("%d %B %Y") %>
      <% else %>
        <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="text-warning"><i class="fa fa-warning"></i> Please update </a>
      <% end %>  
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4 text-right text-muted">Country</div>
    <div class="col-xs-8 text-warning">
      <% if !@instructor_student.country.blank? %>
        <%= @instructor_student.country %>
      <% else %>
        <a href="<%= edit_student_path(@instructor_student.secret_token) %>" class="text-warning"><i class="fa fa-warning"></i> Please update </a>
      <% end %>  
    </div>
  </div>
  <hr>
  <div class="row margin-bottom-10">
    <div class="col-xs-12"><h2>Contact</h2></div>
    <% @instructor_student.student_contacts.each do |student_contact| %>
      <div class="row">
        <div class="col-xs-4 text-right text-muted">
          <% if student_contact.relationship? %>
          <%= student_contact.relationship %>
          <% else %>
          Contact
          <% end %>
        </div>
        <div class="col-xs-8"><%= student_contact.contact %><br><%= student_contact.email %></div>
      </div>
    <% end %>
  </div>
  <hr>
  <div class="row">
    <div class="col-xs-6"> <h2>Gallery</h2></div>
    <div class="col-xs-6 text-right">
      <!-- instructor_instructor_student_path(@instructor_student) -->
      <%= link_to 'View Gallery', student_public_gallery_path(@instructor_student.secret_token),class: 'btn btn-sm default' %>
    </div>
  </div>
  <% if  !@gallery.nil? %>
    <% count = 0 %>
    <% if !@gallery.photos.empty? && !@instructor_student.photo_tags.empty? %>
      <div class="row">
        <% @instructor_student.gallery.photos.limit(4).each do |p| %>
          <% count = count + 1 %>
          <div class="col-xs-3" style="padding-left: 0px ! important; padding-right: 0px ! important;">
            <div class="mix-inner img">
              <a href="<%= student_public_gallery_path(@instructor_student.secret_token) %>">
                <%= image_tag p.student_photo.url(:small) , :id => "img",:class =>"img img-responsive" %>
              </a>
            </div>
          </div>
        <% end %>
        <% @instructor_student.photo_tags.each do |p| %>
          <% break if count == 4 %>
          <% if p.phototaggable_type == 'Photo' %>
              <% if p.phototaggable.instructor_student == @instructor_student %>
                <% next %>
              <% end %>
            <% tagged_photo = p.phototaggable.student_photo %>
          <% else %>
            <% tagged_photo = p.phototaggable.photo %>
          <% end %>
          <% count = count + 1 %>
          <div class="col-xs-3" style="padding-left: 0px ! important; padding-right: 0px ! important;">
            <div class="mix-inner img">
              <a href="<%= student_public_gallery_path(@instructor_student.secret_token) %>">
                <%= image_tag tagged_photo.url(:small) , :id => "img",:class =>"img img-responsive" %>
              </a>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="col-xs-12 text-center">
        No photos yet. <br><br>
        <div data-filter="all" type="button" class="btn green", id="upload_file" data-toggle="modal" data-target="#myModal">Upload</div>
      </div><br><br><br><br><br><br><br><br><br>
    <% end %>
  <% end %>
   
  <%# @instructor_student_award.each do |instructor_student_award| %>
    <%# if !instructor_student_award.award.blank? %>
      <%# if !instructor_student_award.is_registered? %>
        <!-- <div class="alert alert-info">Your child is now ready for <strong> -->
            <%#= instructor_student_award.award.name %>
          <!-- </strong> test now! <a href="<%#= test_registration_path(@instructor_student.secret_token, :awardName => instructor_student_award.award.name) %>">Register for test here</a> -->
        <!-- </div> -->
      <%# end %>
    <%# end %>
  <%# end %>
  <%# if params[:isAppliedFor] %>
  <%# if @instructor_student.is_registered? %>
   
  <%# end %>
  <hr>
  <div class="row">
    <div class="col-xs-6"> <h2>Fees</h2></div>
    <div class="col-xs-12">
      <% @display_fee = false %>
      <% if @instructor_student.chek_monthly_fee.present? %>
        <% if !@instructor_student.chek_monthly_fee.is_paid && @instructor_student.chek_monthly_fee.payment_status == 'New'  %>
          <% @display_fee = true %>
        <% end %>
      <% else %>
        <% @display_fee = true %>
      <% end %>
      <%@next_month_fee=(Date.today() + 1.month).strftime("%B %Y") %>
      <%# if @instructor_student.fees.where("payment_status IS NOT NULL OR is_due_by_student = (?)",true).count > 0 %>
      <% if @instructor_student.fees.where.not(payment_status: nil).count > 0 %>
        <table class="table table-striped table-hover">
          <thead>
              <tr>
                  <th> # </th>
                  <th> Month</th>
                  <th>Fee</th>
                  <th> Status </th>
                  <th> Action </th>
              </tr>
          </thead>
          <tbody>
            <%if @display_fee && @instructor_student.admin_user.enable_feature %>
              <tr>
                <td colspan="5" align="center">
                  <%= link_to 'Pay For '+@next_month_fee,current_month_fee_path(@instructor_student.secret_token,:monthly_detail=>(Date.today() + 1.month).strftime("%Y-%m-01")),class: 'btn green',data: { disable_with: "Please wait.." } %>
                </td>
              </tr>
            <%end %>
            
            <%# @instructor_student.fees.where("payment_status IS NOT NULL AND is_due_by_student").order("monthly_detail DESC").each_with_index do |fee,index| %>
            <%# @instructor_student.fees.where("payment_status IS NOT NULL OR is_due_by_student = (?)",true).order("monthly_detail DESC").each_with_index do |fee,index| %>

            <% @instructor_student.fees.where.not(payment_status: nil).order("monthly_detail DESC").each_with_index do |fee,index| %>

              <% if fee.payment_status != 'New' || fee.is_paid %>
                <tr>
                  <td><%= index+1 %></td>
                  <td><%= fee.monthly_detail.strftime('%b %Y') unless fee.monthly_detail.blank? %></td>
                  <td><%= fee.amount %></td>
                  <td><%= fee.is_fee_paid.blank? ? fee.payment_status : 'Paid' %></td>
                  <td>
                    <% if !fee.is_paid && @instructor_student.admin_user.enable_feature %>
                      <%= link_to 'Pay Now',payment_options_path(@instructor_student.secret_token,fee.id,from_pub_profile: true),class: 'btn green' %>
                    <% elsif fee.is_paid %>
                      <%= link_to 'View Receipt',payment_options_path(@instructor_student.secret_token,fee.id),class: 'btn default' %>
                    <% else %>
                      <%= link_to 'View invoice',payment_options_path(@instructor_student.secret_token,fee.id),class: 'btn green' %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="col-xs-12 text-center">
          <%if @display_fee && @instructor_student.admin_user.enable_feature %>
            <%= link_to 'Pay For '+@next_month_fee,current_month_fee_path(@instructor_student.secret_token,:monthly_detail=>(Date.today() + 1.month).strftime("%Y-%m-01")),class: 'btn green',data: { disable_with: "Please wait.." } %><br><br>
          <%end %>
        </div>
      <% end %>
    </div>
  </div>
  <div>
    <hr>
    <h2>Progress</h2>
    <div class="margin-bottom-10  ">
      <div class="col-xs-12 text-right small defaultError" style="padding-right: 0px;">
        <a href="http://www.swimsafer.com.sg" target="_blank">Click for more information on SwimSafar</a>
      </div>
    </div>
    <div class="row">
      <% Award.all.order("position").each_with_index do |award,index| %>
        <% st_award = @instructor_student.instructor_student_awards.where(award_id: award.id).first %>
        <% if index%3 == 0 %>
          </div><div class="row">
        <% end %>
        <% not_pass = [ "Confirmed","pending", "Pending","confirmed", "fail", "Fail",nil] %>
        <% pass = ['Pass','pass'] %>
        <% opacity = 0.3 %>
        <% if !st_award.nil? %>
          <% if pass.include?(st_award.status) || st_award.award_progress == 'achieved' %>
            <% opacity = 1 %>
          <% end %>
        <% end %>
        <div class="col-xs-4 text-center" style="margin-bottom:20px;">
          <% if award.image? %>
            <center>
              <%= image_tag(award.image(:medium),:class => "img-responsive",style:'opacity:'+opacity.to_s+';')%>
            </center>
          <% else %>
            <center>
              <img src="/assets/award.png" alt="", class="img-responsive tooltips" data-original-title="<%= award.name %>" style='opacity:<%= opacity %>;'/>
            </center>
          <% end %>
          <div style="line-height: 1;">
            <small>
              <span style='opacity:<%= opacity %>;'><%= award.name %></span>
              <br>
              <% if !st_award.nil? %>
                <% if ['fail', 'Fail'].include?(st_award.status) %>
                  <% if  st_award.award_progress == 'ready_for'%>
                    <strong>Ready</strong>
                    <a href="<%= test_registration_path(@instructor_student.secret_token, :awardName => st_award.award.name) %>" class = "btn btn-block green margin-top-6">Book Test</a>
                  <% elsif st_award.award_progress == 'training_for' %>
                    <strong>Training</strong>
                  <% end %>
                <% else %>
                  <strong>
                    <% if pass.include?(st_award.status) || st_award.award_progress == 'achieved' %>
                       Achieved
                      <% if st_award.achieved_date.present? %>
                        <%= st_award.achieved_date.strftime('%d/%m/%Y') %>
                      <% else %>
                        <%= st_award.award_test.test_date.strftime('%d/%m/%Y') if st_award.award_test.try(:test_date) %>
                      <% end %>
                    <% elsif st_award.award_progress == 'ready_for' && not_pass.include?(st_award.status) && !st_award.is_registered? %>
                      Ready
                    <% elsif st_award.award_progress == 'training_for' && !pass.include?(st_award.status) %>
                      Training
                    <% else %>
                    <% end %>
                  </strong>
                  <% if @ready_award.include?(st_award) %>
                    <%if @instructor_student.student_name != nil && @instructor_student.ic_number != nil && @instructor_student.date_of_birth != nil && @instructor_student.gender != nil && @instructor_student.student_name != '' && @instructor_student.ic_number != '' && @instructor_student.date_of_birth != '' && @instructor_student.gender != '' %>
                      <%if !st_award.is_registered? && st_award.award_progress == "ready_for" %>
                        <a href="<%= test_registration_path(@instructor_student.secret_token, :awardName => st_award.award.name) %>" class = "btn btn-block green margin-top-6">Book Test</a>
                      <% else %>
                        <strong>Booked <%= st_award.award_test.test_date.strftime('%d/%m/%Y') %></strong><br>
                        <% unless AwardTestPaymentNotification.check_paid_or_not(st_award.award_test.id,@instructor_student.id) %>
                          <%= link_to @instructor_student.admin_user.enable_feature ? 'Pay Now' : 'View invoice',award_test_payment_options_path(@instructor_student.secret_token,st_award.award_test.id,from_pub_profile: true),class: 'btn green' %>
                        <% else %>
                          <%= link_to 'Receipt',award_test_payment_options_path(@instructor_student.secret_token,st_award.award_test.id),class: 'btn default' %>
                        <% end %>
                      <% end %>
                    <% else %>
                      <%if !st_award.is_registered? && st_award.award_progress == "ready_for" %>
                        <a href="javascript:void(0)" class = "btn btn-block green margin-top-6" id= "reigster_btn">Book Test</a>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </small>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Upload photos</h4>
      </div>
      <div class="modal-body">
        <%= form_for [:instructor, @instructor_student,@gallery, Photo.new], html: { multipart: true, :remote => true, :class => "dropzone", :id => "media-dropzone"}  do |f| %>
          <div class="fallback">
            <%= f.file_field :student_photo ,as: :file ,:id => "img"%>
            <%= f.submit "Submit" ,:id =>"file_submit" %>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script>

  var baseUrl1;
  if ($('#media-dropzone').length) {
    Dropzone.options.mediaDropzone = false;
    // Dropzone.options.acceptedFiles: ".jpeg,.jpg,.png,.gif";
    baseUrl1 = $('#media-dropzone').attr('action');
    window.mediaDropzone = new Dropzone('#media-dropzone', {
      addRemoveLinks: true,
      acceptedFiles: ".jpeg,.jpg,.png,.gif",
      success: function(file, responseText) {
        var _this = this;
        // appendContent(responseText.student_photo, responseText.student_photo_original,responseText.id);
        
      },
      init: function () {
        this.on("complete", function (file) {
          if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
            window.location.reload();
          }
        });
      }
    });
  };

$(".tooltips").tooltip();
  $(document).ready(function () {
    $('#fine-uploader').fineUploader({
      multiple: false,
      request: {
        endpoint: '/instructor/student_profile/<%= @instructor_student.id %>'
      }, 
      callbacks: {
        onComplete: function(id, name, responseJSON, xhr) {
          var latestImgUrl = responseJSON;
          $(".studentProfilePic").find('img').remove();
          var latestUploadImg = '<img class="img-responsive" src="'+latestImgUrl+'" />';
          $(".studentProfilePic").find("#fine-uploader").before(latestUploadImg);
          $('#qq-progress-bar').html('');
        }
      }
    }).on('progress', function (event, id, name, uploadedBytes, totalBytes) {
      fileName = name
      if (uploadedBytes < totalBytes) {
        progress = Math.round(uploadedBytes / totalBytes * 100) + '%';
        $('#qq-progress-bar').html(progress);
        $("#add_student_photo").find('#lbl_add_photo').text("Adding...");
      }
      else {
        $('#qq-progress-bar').html('Saving...');
        $("#add_student_photo").find('#lbl_add_photo').text("Change photo");
      }
    });
    $(document).on('click', '#reigster_btn', function(){
      $('.error-register').show();
      $('html, body').animate({
          scrollTop: $('.error-register').offset().top - 50
      }, 1500);
    });
  });
</script>
<%if @instructor_student.profile_picture? %>
   <script type="text/template" id="qq-template">
    <div class="qq-uploader-selector qq-uploader">
      <div class="qq-upload-button-selector " id="add_student_photo">
        <div id="lbl_add_photo">Change photo</div>
      </div>
      <div id="qq-progress-bar"></div>
      <ul class="qq-upload-list-selector qq-upload-list">
        <li style="display: none;">
        </li>
      </ul>
    </div>
  </script>
<%else %>
  <script type="text/template" id="qq-template">
    <div class="qq-uploader-selector qq-uploader">
      <div class="qq-upload-button-selector " id="add_student_photo">
        <div id="lbl_add_photo">Add photo</div>
      </div>
      <div id="qq-progress-bar"></div>
      <ul class="qq-upload-list-selector qq-upload-list">
        <li style="display: none;">
        </li>
      </ul>
    </div>
  </script>
<%end %>

<!-- qq-upload-button -->
<style type="text/css">
  .margin-top-6{
    margin-top: 6px;
  }
  .qq-upload-button {
    background:  #FFF;
  }
  .qq-upload-list li.qq-upload-fail {
    background-color: #0D7D18;
    color: #FFF;
  }
  #add_student_photo input[type="file"]{
    max-width: 100px !important;
    max-height: 100px !important;
    right: 268px !important;
  }
  .error{
    color: red;
  }
  #fine-uploader input{
    left: 0;
  }


</style>