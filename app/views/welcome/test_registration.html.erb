<% title @instructor_student.student_name %>
<% @blankAwardTest = false %>
<div class="container">
  <div class="row margin-bottom-40">
    <div id="lead_show" class="col-xs-12 col-sm-5">
      <div class="margin-top-20">
        <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20">
      </div>
      <h3>Booking Test</h3>
      <div class="col-xs-12">
        <div class="alert alert-warning">
          <strong><%= @instructor_student.student_name %></strong><br/>
          <small>The above name will be printed on the certificate. No change is allowed after booking.</small><br/>
          <p class="text-right">
            <a href="<%= edit_student_path(@instructor_student.secret_token) %>">Update name now</a>
          </p>
        </div>
      </div>
     <!-- <div class="col-xs-12" align="center">
        <a href="<%#= edit_student_path(@instructor_student.secret_token) %>" class="btn btn-block default margin-bottom-20">Update Info</a>
      </div> -->
      <div class="col-xs-12">
        <h4>
          
          <%= @award.name if @award %>
        </h4>
        <%= form_tag instructor_home_get_registered_for_test_path(:Xauth => true), :class => "form-horizontal form-row-stripped col-xs-12 form_registered" do %>
          <div class="form-body">
            <div class="form-group">
              <div class="radio-list">
                <input type="hidden" name="award_id" value="<%= @award.id %>"></input>
                <input type="hidden" name="inst_student_id" value="<%= params[:id] %>"></input>
                <input type="hidden" name="group_class_id" value="<%= params[:gp_id] %>"></input>
                <input type="hidden" name="userXauth" value="<%= params[:secret_token] %>"></input>
                <% cnt = 0 %>
                <% if @instructor_student_award.count == 0 %>
                  <% @blankAwardTest = true %>
                <% end %>
                <% @instructor_student_award.each do |instructor_student_award| %>
                  
                  <% @award_tests = AwardTest.where(:award_id => @award.id).order("test_date asc, test_time asc") %>
                  <% if @award_tests.blank? %>
                    <% @blankAwardTest = true %>
                  <% end %>
                  <%if instructor_student_award.award_id == @award.id %>
                    <% @award_tests.each do |award_test| %>
                      <%if !award_test.test_date.blank? %>
                        <%@remaining_days = award_test.test_date >=  Date.today()%>
                      <%end %>

                      <%if @remaining_days %>
                        <% @instructor_student_awards = InstructorStudentAward.where(:award_id => award_test.award_id, :award_test_id => award_test.id ).count %>
                        <%if !award_test.total_slot.blank? %>
                          <% total_vacancy = award_test.total_slot - @instructor_student_awards %>
                        <%end %>
                        <%#if !total_vacancy.blank? %>
                          <%#if total_vacancy > 0  %>
                            <% if Venue.exists?(award_test.venue_id) %>
                              <% @venue = Venue.find_by_id(award_test.venue_id) %>
                            <% end %>
                            <label class="margin-bottom-20">
                              <div class="radio <%= award_test.id %>">
                                <span>
                                  <%if (award_test.cut_off_date > Date.today()) == false || total_vacancy == 0 %>
                                    <input type="radio" name="award_test_id" disabled>
                                  <%else %>
                                    <%= radio_button_tag :award_test_id, award_test.id %>
                                  <%end %>
                                </span>
                                <%= award_test.test_date.strftime("%d %B %Y") %> - <%= award_test.test_time.strftime("%l:%M %p") %> (<%= award_test.test_date.strftime('%A') %>)<br>
                                <%= @venue.name %><br>
                                <%= award_test.assesment_ref_no.nil? || award_test.assesment_ref_no == '' ? '' :  ('Grouping : ' + award_test.assesment_ref_no + '<br>').html_safe %>
                                <small>
                                  Test Fee: $<%= format('%.2f', award_test.test_fee) if award_test.test_fee.present? %><br/>
                                

                                  <%if (award_test.cut_off_date >= Date.today()) == false  %>
                                      <span style="color:red;">Booking closed on <%=award_test.cut_off_date.strftime('%d/%m/%y') %></span><br>
                                  <%else %>
                                    <%if total_vacancy == 0%> 
                                      <span style="color:red;">Fully Booked</span><br>
                                    <%else %>
                                      <% if !award_test.cut_off_date.blank? %>
                                        <% @remaining_days = (award_test.cut_off_date - Date.today()).to_i %>
                                      <% end %>
                                      
                                      <% if @remaining_days > 0%>
                                        <%= total_vacancy %> vacancy available<br/>
                                      <% end %>
                                      <!-- Booking closed on <%#=award_test.cut_off_date.strftime('%d/%m/%y') %> -->
                                      <% if @remaining_days == 1 %>
                                        Today is last date for booking.
                                      <% elsif @remaining_days == 2 %>
                                        Tomorrow is last date for booking.
                                      <% elsif @remaining_days == 0 %>
                                        <span style="color:red;">Fully Booked</span><br>
                                      <% else %>
                                        <%= @remaining_days %> days left for booking.
                                      <% end %>
                                    <%end %>
                                  <%end %>

                                </small>
                              </div>
                            </label>
                          <%#end %>
                        <%#end %>
                      <%end %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
                <div class="row">
                  <div class="col-xs-4">
                    <%= link_to "Back", student_public_link_path(@instructor_student.secret_token), :class=> "btn btn-block default" %>
                  </div>
                  <div class="col-xs-8">
                    <%= submit_tag "Confirm Booking" ,:class=>"btn btn-block green", :id => "book_test" %>
                  </div>
                </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body">
        <p>Sorry, this class was just fully booked.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default close_button" data-dismiss="modal">Okay</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">

$(document).ready(function($) {
  var award_test_id
  if($(".radio").length == 0)
    $("#book_test").attr('disabled','disabled');
  else
  $("#book_test").attr('disabled','disabled');

  if($("input[name='award_test_id']:checked").length > 0)
    $("#book_test").removeAttr('disabled');
    
  $("input[name=award_test_id]:radio").change(function () {
    console.log($("input[name='award_test_id']").is(':checked'));
    console.log($(this).val());
    award_test_id=$(this).val();
    $("#book_test").removeAttr('disabled');
  });

  $('#book_test').click(function(event){
    event.preventDefault();
    $(this).val('please wait..');
    console.log(award_test_id);
    $.ajax({
      url: '/instructor/check_availablity_for_test/'+award_test_id,
      type: 'GET',
      dataType: 'html',
    })
    .done(function(data) {
      console.log(data);
      if(data == 0)
      {
        $('.modal').modal('show');
      }
      else{
        $('.form_registered').submit();
      }
      console.log("success");
    })
    .fail(function() {
      console.log("error");
    })
    .always(function() {
      console.log("complete");
    });
    
  }); 
  
  $('.close_button').click(function(event) {
    // $('#book_test').val('Confirm Booking');
    location.reload();
  });
});

  
</script>

<style type="text/css">
.modal-footer {
    padding: 11px 20px 20px;
    margin-top: -21px;
    text-align: center;
}
.modal-body p{
  font-size: 14px;
}
</style>