<script src="https://www.xfers.io/xfersjsapi"></script>
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<div class="main">
  <% if !@invoice.blank? %>
    <% if @job.allow_paypal?  %>
      <% payment_ad_m = "paypal" %>
    <% else %>
      <% payment_ad_m = "bank_transfer" %>
    <% end %>
    <input type="hidden" value="<%= payment_ad_m %>" name="payment_method" id="payment_method">
    <input type="hidden" value="<%= @invoice.invoice_number %>" name="invoiceId" id="invoiceId">
    <input type="hidden" value="<%= @xfers_key %>" name="xfersKey" id="xfersKey">

    <% amount = @job.referral %>
    <% if @job.request_full_payment? %>
      <% amount = @job.fee_total %> 
    <% end %>

    <input type="hidden" value="<%= amount %>" name="totalAmount" id="totalAmount">
    <input type="hidden" value="<%= @job.lead_email %>" name="customerEmail" id="customerEmail">
  <% end %>
  <div class="container">
    <div class="margin-bottom-40">
      <div id="lead_show" class="col-xs-12 col-sm-5">
        <% if @invoice.blank? %>
          <div class="margin-top-20">
            <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20" />
          </div>
          <div class="form-body">
            <div class="form-group">
              <p class="text-center">This payment advise is no longer available.
                <br>
                Please request for a new link.
              </p>
            </div>
          </div>
        <% else %>
          <div class="margin-top-20" id="div1">
            <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20" />
            <h1 style="margin-top: 0px;">REF <%= @job.id %></h1>
            <table class="table table-striped table-hover">
              <tbody>
                <tr>
                  <td>
                    <%= simple_format(@message_template_decode.gsub('\r\n','<br>')).html_safe if @message_template_decode.present? %>
                  </td> 
                </tr>
              </tbody>
            </table>
            <div>
              <%#if(@invoice.invoice_time < Time.now + (24*60*60))%>
               <!--  <p>Your booking will expire in <span id="<%=@invoiceTimer%>" class="invoice_time"></span></p> -->
              <%#else%>
                <p id="<%=@invoiceTimer%>" class="invoice_time"></p>
              <%#end%>
            </div>
            <div class="row margin-bottom-20">
              <div class="col-xs-12">
                <a href="javascript:;" class="btn green pull-right nextBtn" style="margin-bottom: 30px !important;">Next</a>
              </div>
            </div>
          </div>
          <div class="margin-top-20 form-body" id="div2">
            <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20" />
            <% if @job.terms_and_conditions.count > 0 %>
              <div class="form-group">
                <h3>Terms & Condition</h3>
                <% @job.terms_and_conditions.each do |terms_and_condition| %>
                  <h4><%= terms_and_condition.title %></h4>
                  <%= simple_format(terms_and_condition.content).html_safe if terms_and_condition.content? %>
                <% end %>
                <hr/>
              </div>
            <% end %>
            <div class="form-group">
              <% if !@payment_notification.blank? %>              
                <h4 class="paid" >Amount Paid : $<%= number_with_precision(@payment_notification.amount, :precision => 2) %></h4>
              <% else %>  
                <h4 class="payable">Amount payable : $<%= number_with_precision(amount, :precision => 2) %></h4>
              <% end  %>
              <%# unless @is_payment_done == "Completed" || @is_payment_done == "Added" %>
                <!-- <h4 class="payable">Amount payable : $<%= amount %></h4> -->
                <!--<h4 class="paid" style="display:none;" >Amount Paid : $<%#= amount %></h4> -->
              <%# else %>              
                <!--<h4 class="paid" >Amount Paid : $<%#= amount %></h4> -->
              <%# end %>
              <div class="alert alert-warning mybank_transfer" style="display:none;">
                Your payment is still pending, and will not be reflected in the invoice below yet.
              </div>
                <div class="redDotError">
                  
                </div>

              <%# if (@job.job_status != "Receipt" && @is_payment_done == "Completed")|| params[:customer].present? || (@is_payment_done == "Completed" && @payment_notification.bank_id.nil?) %>
              <% if (@job.job_status != "Receipt" && @is_payment_done == "Completed")|| (@job.job_status != "Receipt" && @is_payment_done == "Paid") || params[:customer].present? || (@is_payment_done == "Completed" && @payment_notification.bank_id.nil?) %>
                <div class="alert alert-warning">
                  Your payment is still pending, and will not be reflected in the invoice below yet.
                </div>
                
                <% if @invoice != "" %>
                  <% if params[:paid_by].present? &&  params[:error_code].present? %>
                    <a href="javascript:;" class="btn green btn-block btn-sm-4 try-again-button" style="margin-bottom: 30px !important;">Try again</a>
                    <a href="<%= @invoice_freshbook["invoice"]["links"]["client_view"] %>" class="btn btn-default btn-block btn-sm-4 view-invoice" target="_blank" style="display: none;">View Invoice</a>
                  <% else%>
                  
                    <a href="<%= @invoice_freshbook["invoice"]["links"]["client_view"] %>" class="btn btn-default btn-block btn-sm-4 view-invoice" target="_blank">View Invoice</a>
                  <%end%>
                <% end %>
                </br>
              <% else %>
                <% if @invoice != "" %>
                  <% if params[:paid_by].present? &&  params[:error_code].present? %>
                    <a href="javascript:;" class="btn green btn-block btn-sm-4 try-again-button" style="margin-bottom: 30px !important;">Try again</a>
                    <a href="<%= @invoice_freshbook["invoice"]["links"]["client_view"] %>" class="btn btn-default btn-block btn-sm-4 view-invoice" target="_blank" style="display: none;">View Invoice</a>
                  <% else%>
                    <a href="<%= @invoice_freshbook["invoice"]["links"]["client_view"] %>" class="btn btn-default btn-block btn-sm-4 view-invoice" target="_blank">View Invoice</a>
                  <%end%>
                <% end %>
                </br>
                <% if @job.job_status != "Receipt" && @payment_notification.blank? %>
                  <div class="payment_methods">
                    <% if @job.is_enable_payment_mode %>
                      <label><strong>1.Select Payment Method</strong></label><br />
                      <% if @job.allow_paypal? %>
                        <label>
                          <input type="radio" name="payment_mode" value="paypal" id="rdo_payment_mode" />
                          paypal / credit card
                        </label><br>
                      <% end %>
                      <% if @job.allow_xfers? %>
                        <label>
                          <input type="radio" name="payment_mode" value="bank_transfer" id="rdo_payment_mode" />
                          XFERS
                        </label><br>
                      <% end %>
                      <% if @job.allow_red_dot? %>
                        <label>
                          <input type="radio" name="payment_mode" value="reddot-card" id="rdo_payment_mode" />
                          <img src="/assets/master_card_logo.jpg" class="payment_mode_logo">
                          <img src="/assets/visa_card_logo.jpg" class="payment_mode_logo">
                        </label><br>
                      <% end %>
                      <% if @job.enets? %>
                        <label>
                          <input type="radio" name="payment_mode" value="reddot-eNets" id="rdo_payment_mode"/>
                          <img src="/assets/eNETS_logo.jpg" class="payment_mode_logo">
                        </label><br>
                      <% end %>
                      <%if @job.bank_transfer? %>
                        <label>
                          <input type="radio" name="payment_mode" value="nextB" id="rdo_payment_mode" />
                          bank transfer
                        </label><br>
                      <% end %>
                      <br/>
                      <label><strong>2.Enter Email Address</strong></label><br/>
                      <div class="input-group">
                        <span class="input-group-addon">
                          <i class="fa fa-envelope"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Email Address" id="custom_email" value="<%= @job.lead_email %>">
                      </div>
                      <div class="email_validation"></div>
                      <br/>
                      <button class="btn default btn-block real_dot btn-sm-4 demo-button margin-tb-5" disabled id="real_dot" >Pay Now</button>
                    <% end %>
                    
                    <% if @job.allow_paypal? %>
                      <%# @invoice_id = @invoice.freshbooks_invoice_id %>
                      <% unless @is_payment_done == "Completed"   %>
                        <% @invoice_id = @invoice.invoice_number %>
                        <a href="<%= @invoice.paypal_url(view_pa_url(@job.id, params[:u_sec_number], :amount => amount, :customer => @job.lead_email, :payment_method => 'paypal'), params[:id], amount, create_payment_notifications_url, @invoice_id.to_s) %>" class="btn default btn-block paypal btn-sm-4 hide_payment margin-tb-5" id="real_dot">Pay Now</a>
                      <% end %>
                    <% end %>
                    <% if @job.allow_xfers? %>
                      <a class="btn default btn-block bank_transfer btn-sm-4 hide_payment margin-tb-5" onclick="buy('<%= create_payment_notifications_url %>','<%= @job.id %>')" id="real_dot">Pay Now</a>
                    <% end %>
                    <% if @job.allow_red_dot? %>
                      <%= form_tag (ReddotCredential.first.url),class:'reddot-card hide_payment' do %>
                        <%#= hidden_field_tag :order_number,@invoice.invoice_number.to_s+"_"+Time.now.to_i.to_s %>
                        <%= hidden_field_tag :order_number,'REF'+ @job.id.to_s %>
                         <%= hidden_field_tag :merchant_reference,@invoice.invoice_number.to_s+"_"+Time.now.to_i.to_s %>
                        <%= hidden_field_tag :merchant_id, ReddotCredential.first.merchant_id%>
                        <%= hidden_field_tag :key, ReddotCredential.first.key%>
                        <%= hidden_field_tag :amount, @amount > 0 ? @amount : amount%>
                        <%= hidden_field_tag :currency_code, 'SGD' %>
                        <%= hidden_field_tag :email,nil,class: "email" %>
                        <%= hidden_field_tag :transaction_type, 'Sale' %>
                        <% if request.domain == "pinkynbrain.com" || request.domain == "localhost" %>
                          <%= hidden_field_tag :return_url,  "http://pinkynbrain.com"+red_dot_return_response_path %>
                          <%= hidden_field_tag :notify_url, 'http://pinkynbrain.com'+ red_dot_notification_path %>
                        <% else %>
                          <%= hidden_field_tag :return_url,  "http://app.singaporeswimming.com"+red_dot_return_response_path %>
                          <%= hidden_field_tag :notify_url, 'http://app.singaporeswimming.com'+ red_dot_notification_path %>
                        <% end %>
                        
                      <%= submit_tag "Pay Now", :class=>'btn default btn-block real_dot btn-sm-4 margin-tb-5', id: "real_dot"%>
                      <% end %>
                    <% end %>  
                    <% if @job.enets? %>
                      <%= form_tag(ReddotCredential.second.url,class:'reddot-eNets hide_payment') do %>
                        <%#= hidden_field_tag :order_number, @invoice.invoice_number.to_s+"_"+Time.now.to_i.to_s%>
                        <%= hidden_field_tag :order_number,'REF'+ @job.id.to_s %>
                        <%= hidden_field_tag :merchant_reference,@invoice.invoice_number.to_s+"_"+Time.now.to_i.to_s %>
                        <%= hidden_field_tag :merchant_id, ReddotCredential.second.merchant_id%>
                        <%= hidden_field_tag :key, ReddotCredential.second.key%>
                        <%= hidden_field_tag :amount, @amount > 0 ? @amount : amount%>
                        <%= hidden_field_tag :currency_code, 'SGD' %>
                        <%= hidden_field_tag :email,nil,class: "email" %>
                        <%= hidden_field_tag :transaction_type, 'Sale' %>
                        <% if request.domain == "pinkynbrain.com" || request.domain == "localhost" %>
                          <%= hidden_field_tag :return_url,  "http://pinkynbrain.com"+enets_return_response_path %>
                          <%= hidden_field_tag :notify_url, 'http://pinkynbrain.com'+ red_dot_notification_path %>
                        <% else %>
                          <%= hidden_field_tag :return_url,  "http://app.singaporeswimming.com"+enets_return_response_path %>
                          <%= hidden_field_tag :notify_url, 'http://app.singaporeswimming.com'+ red_dot_notification_path %>
                        <% end %>
                        
                        <%= submit_tag "Pay Now", :class=>'btn default btn-block real_dot btn-sm-4 margin-tb-5',id: "real_dot"  %>
                      <% end %>
                    <% end %>
                    <%if @job.bank_transfer? %>
                      <% unless @is_payment_done == "Completed" %>
                        <% @invoice_id = @invoice.invoice_number %>
                        <a href="javascript:;" class="btn default hide_payment btn-block btn-sm-4 nextB margin-tb-5" id="real_dot">Pay Now</a>
                      <% end %>
                    <% end %>
                  </div> 
                <% end %>
              <% end %>
              <a href="javascript:;" class="margin-top-10 btn green previousBtn" style="margin-bottom: 30px !important;">Previous</a>
            </div>
          </div>
          <div id="div3">
            <img src="/assets/index_page_images/img/SSA-Logo-Raw-Black.png" class="margin-bottom-20" style="margin-top: 20px !important;">
            </br>
            <div>
              <div class="note note-info">
                BANK TRANSFER</br>
                1) Transfer $<%= amount %> to any bank below.</br>
                2) Select the bank you have transferred.</br>
                3) Click "Transferred" button. 
              </div>
              <h4>Amount payable : $<%= amount %></h4>
              <% all_bank = BankDetail.all %>
              <% unless !@bank_detail.blank? %>    
                <%= form_tag bank_transferred_path(@job.id), method: :post, :class => "tansfer_form", :remote => true do %>
                  <input id="invoice_id" name="invoice_id" value="<%= @invoice.invoice_number %>" type="hidden" />
                  <input id="amount" name="amount" value="<%= amount %> " type="hidden" />
                    <% all_bank.each do |b| %>
                      <label>
                        <input type="radio" name="bank_id" id="bank_id" value="<%= b.id %>-<%= b.bank_name %>-<%= b.account_number %>" class="bank_name">
                        <%= b.bank_name %>
                      </br>
                      <b>Account No.</b><%= b.account_number %>
                      </label></br>
                    <% end  %>            
                  <div>
                  </br>
                  <%#= submit_tag "Transferred", :class => " nextBD btn blue pull-right bank_transfer_btn", :disabled => true %>
                  <div class="modal fade bs-modal-sm in" id="small" tabindex="-1" role="basic" aria-hidden="false" style="display: none;">
                      <div class="modal-dialog">
                        <div class="modal-content">
                         <div class="modal-body">
                            <b>I confirm that I have done the following transfer</b>
                            </br>
                            Amount: $<%= amount %> </br> 
                            <div class="modal_bank_details">                              
                            </div> 
                          </div>
                          <div class="modal-footer">
                          <%= submit_tag "confirm", :class => " btn blue confirm" %>
                          <button type="button" class="btn default" data-dismiss="modal" onClick="window.location.reload();">Close</button>
                          </div>
                        </div>
                      </div>
                  </div>
                  <button type="button" class="btn blue pull-right bank_transfer_btn"  data-toggle="modal" , disabled = "true" > Transferred </button>
                          <!-- 
                      <a class="btn blue pull-right bank_transfer_btn" type="submit" data-toggle="modal" , disabled = "true" > Transferred </a> -->
                      <a href="javascript:;" class="btn green pull-left previousB">Previous</a>
                      </div>
                  <% end %>  
              <% end %>  
          </div>
          <div class="clear"></div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.6/jstz.js"></script>
<script type="text/javascript">
  var intl;
  <% if @invoiceTimer > 0 || @invoiceTimer < 0%>
  $(document).ready(function(){
     // console.log($('.invoice_time').attr('id'));
    var invoice = $('.invoice_time').attr('id');
    // var date = moment().add(1, 'days').format('YYYY/MM/DD HH:mm:ss');
    l = invoice *1
    if (l > 0 && l > 60){
      var minute = invoice/60
      var hours = minute/60
      var hh = Math.floor(hours);
      var mm = Math.floor(minute - hh*60)

      $('.invoice_time').html('<div class="alert alert-success">Your booking will expire in<b> '+hh+'hr '+mm+ 'mins</b></div>');
      intl = setInterval(function(){
        console.log(mm < 0);
        var isOver = false;
        mm --;
        if(mm < 0 ){
          hh--;
          mm = 59;
          if (hh < 0){
            clearInterval(intl);
            $('.invoice_time').html('<div class="alert alert-warning">Your booking has expired.please contact your coordinator to book again.</div>');
            $('.nextBtn').attr('disabled', 'true');
            isOver = true;
          }
        }
        if (isOver== false){ 
          $('.invoice_time').html('<div class="alert alert-success">Your booking will expire in<b> '+hh+'hr '+mm+ 'mins</b></div>');
        }
      },60000);
    }else{
      $('.invoice_time').html('<div class="alert alert-warning">Your booking has expired.please contact your coordinator to book again.</div>');
      $('.nextBtn').attr('disabled', 'true');
    }
  
  });
  <% end %>
  $(document).ready(function() { 
   

    $(document).on('change', '#rdo_payment_mode', function(event) {
      event.preventDefault();
      $('.demo-button').remove();
      $('.hide_payment').hide();
      $('.'+$(this).val()).css('display','block');
      /* Act on the event */
    });
    $(document).on('click', '#real_dot', function(event) {
      var email_value = $('#custom_email').val();
      if (email_value == ''){
        event.preventDefault();
        $('.payment_methods').css('padding','5px');
        $('.payment_methods').css('border', '3px solid red');
      }
      else{

        var emailFilter = /^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;
        if (!emailFilter.test(email_value)) {
          // alert('Please enter a valid e-mail address.');
          $('.email_validation').html("Please enter a valid e-mail address.");
          $('.email_validation').css("color","red");
          return false;
        }
        else{
          $('.email_validation').hide();
          $('.email').val(email_value);
          console.log($('.email').val(email_value));
          $('.payment_methods').css('padding','0');
          $('.payment_methods').css('border', 'none');
        }

      }
    });
  });
</script>
<style type="text/css">
  .hide_payment{
    display: none;
  }
  .margin-tb-5{
    margin-top: 5px;
    margin-bottom: 5px;
  }
  .payment_mode_logo{
    width: 30%;
  }
</style>